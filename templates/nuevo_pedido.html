{% extends "base.html" %}

{% block title %}Nuevo Pedido - Gesti√≥n de Pedidos{% endblock %}

{% block content %}
<h2>Nuevo Pedido</h2>

<form method="POST" enctype="multipart/form-data">
    <div class="form-row-compact">
        <div class="form-group-compact">
            <label for="comercial_id">Comercial *</label>
            <select name="comercial_id" id="comercial_id" required>
                <option value="">Seleccione un comercial</option>
                {% for comercial in comerciales %}
                <option value="{{ comercial.id }}">{{ comercial.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group-compact">
            <label for="cliente_id">Cliente *</label>
            <select name="cliente_id" id="cliente_id" required>
                <option value="">Seleccione un cliente</option>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group-compact">
            <label for="tipo_pedido">Tipo *</label>
            <select name="tipo_pedido" id="tipo_pedido" required>
                <option value="fabricacion">Fabricaci√≥n</option>
                <option value="no fabricacion">No Fabricaci√≥n</option>
                <option value="cliente web">Cliente Web</option>
            </select>
        </div>

        <div class="form-group-compact">
            <label for="estado">Estado *</label>
            <select name="estado" id="estado" required>
                <option value="Pendiente" selected>Pendiente</option>
                <option value="Dise√±o">Dise√±o</option>
                <option value="En preparaci√≥n">En preparaci√≥n</option>
                <option value="Todo listo">Todo listo</option>
                <option value="Enviado">Enviado</option>
                <option value="Entregado al cliente">Entregado al cliente</option>
            </select>
        </div>
    </div>

    <div class="form-row-compact">
        <div class="form-group-compact">
            <label for="forma_pago">Forma de Pago</label>
            <input type="text" name="forma_pago" id="forma_pago" placeholder="Ej: Transferencia, Efectivo, etc.">
        </div>

        <div class="form-group-compact">
            <label for="fecha_aceptacion">Fecha Aceptaci√≥n</label>
            <input type="date" name="fecha_aceptacion" id="fecha_aceptacion">
        </div>

        <div class="form-group-compact">
            <label for="fecha_objetivo">Fecha Objetivo</label>
            <input type="date" name="fecha_objetivo" id="fecha_objetivo">
        </div>

        <div class="form-group-compact">
            <label for="imagen_diseno">Imagen Dise√±o</label>
            <input type="file" name="imagen_diseno" id="imagen_diseno" accept="image/*">
        </div>
    </div>
    <small style="color: #666; font-size: 11px; display: block; margin-top: -10px; margin-bottom: 15px;">La fecha objetivo se calcula autom√°ticamente (20 d√≠as desde aceptaci√≥n) si se deja vac√≠a</small>

    <h3>Prendas del Pedido</h3>
    <div id="prendas-container">
        <div class="linea-pedido-row">
            <div class="linea-pedido-numero">#1</div>
            <div class="linea-pedido-campos">
                <!-- Orden: nombre_mostrar, unidades, modelo, color, forma, sexo, talla, tejido, precio -->
                <input type="text" name="nombre_mostrar[]" class="linea-campo-compact" placeholder="Nombre para mostrar *" required title="Nombre para mostrar al cliente" style="flex: 3.5;">
                <input type="number" name="cantidad[]" class="linea-campo-compact cantidad" value="1" min="1" required placeholder="Unidades *" title="Unidades">
                <select name="prenda_id[]" class="linea-campo-compact" required title="Modelo">
                    <option value="">Modelo *</option>
                    {% for prenda in prendas %}
                    <option value="{{ prenda.id }}">{{ prenda.nombre }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="color[]" class="linea-campo-compact" placeholder="Color" title="Color">
                <input type="text" name="forma[]" class="linea-campo-compact" placeholder="Forma" title="Forma">
                <select name="sexo[]" class="linea-campo-compact" title="Sexo">
                    <option value="">Sexo</option>
                    <option value="cro">Cro</option>
                    <option value="sra">Sra</option>
                    <option value="unisex">Unisex</option>
                </select>
                <input type="text" name="talla[]" class="linea-campo-compact" placeholder="Talla" title="Talla">
                <select name="tejido[]" class="linea-campo-compact" title="Tejido">
                    <option value="">Tejido</option>
                    <option value="SARGA">SARGA</option>
                    <option value="MICRO">MICRO</option>
                    <option value="NUEVO T.POLO">NUEVO T.POLO</option>
                    <option value="T.CAMISETA">T.CAMISETA</option>
                    <option value="T.SHOFT">T.SHOFT</option>
                </select>
                <input type="number" name="precio_unitario[]" class="linea-campo-compact" step="0.01" min="0" placeholder="Precio ‚Ç¨" title="Precio" style="flex: 0.5;">
                <select name="estado_linea[]" class="linea-campo-compact" required title="Estado">
                    <option value="pendiente" selected>Pendiente</option>
                    <option value="en confecci√≥n">En confecci√≥n</option>
                    <option value="en bordado">En bordado</option>
                    <option value="listo">Listo</option>
                </select>
                
                <!-- Campos personalizados (nombre y cargo) - se muestran al final si tienen valor o si se activa personalizaci√≥n -->
                <input type="text" name="nombre[]" class="linea-campo-compact campo-personalizado" placeholder="Nombre personalizado" title="Nombre personalizado" style="display: none; flex: 2.5;">
                <input type="text" name="cargo[]" class="linea-campo-compact campo-personalizado" placeholder="Cargo" title="Cargo" style="display: none;">
            </div>
            <div class="linea-acciones">
                <button type="button" class="btn-duplicar" onclick="duplicarLinea(this)" title="Duplicar l√≠nea (mantiene todo excepto talla y unidades)">
                    üìã
                </button>
                <button type="button" class="btn-personalizar" onclick="togglePersonalizar(this)" title="Personalizar nombre y cargo">
                    ‚úèÔ∏è
                </button>
                <button type="button" class="btn-remove-linea-inline" onclick="eliminarLinea(this)">√ó</button>
            </div>
        </div>
    </div>

    <button type="button" class="btn btn-primary" onclick="agregarLinea()">Agregar Prenda</button>

    <div class="actions">
        <button type="submit" class="btn btn-success">Guardar Pedido</button>
        <a href="{{ url_for('index.index') }}" class="btn btn-danger">Cancelar</a>
    </div>
</form>

<script>
let contadorPrendas = 1;

// Funci√≥n para calcular autom√°ticamente la fecha objetivo
function calcularFechaObjetivo() {
    const fechaAceptacion = document.getElementById('fecha_aceptacion').value;
    const fechaObjetivo = document.getElementById('fecha_objetivo');
    
    if (fechaAceptacion && !fechaObjetivo.value) {
        const fecha = new Date(fechaAceptacion);
        fecha.setDate(fecha.getDate() + 20);
        const year = fecha.getFullYear();
        const month = String(fecha.getMonth() + 1).padStart(2, '0');
        const day = String(fecha.getDate()).padStart(2, '0');
        fechaObjetivo.value = `${year}-${month}-${day}`;
    }
}

document.getElementById('fecha_aceptacion').addEventListener('change', calcularFechaObjetivo);

function agregarLinea() {
    contadorPrendas++;
    const container = document.getElementById('prendas-container');
    const primeraLinea = container.querySelector('.linea-pedido-row');
    const nuevaLinea = primeraLinea.cloneNode(true);
    
    // Limpiar valores
    nuevaLinea.querySelectorAll('input').forEach(input => {
        if (input.type !== 'button' && input.type !== 'submit') {
            if (input.type === 'number') {
                input.value = '1';
            } else {
                input.value = '';
            }
        }
    });
    nuevaLinea.querySelectorAll('select').forEach(select => {
        if (select.name === 'estado_linea[]') {
            select.value = 'pendiente';
        } else {
            select.selectedIndex = 0;
        }
    });
    
    // Ocultar campos personalizados por defecto
    nuevaLinea.querySelectorAll('.campo-personalizado').forEach(campo => {
        campo.style.display = 'none';
    });
    
    // Resetear bot√≥n de personalizar
    const btnPersonalizar = nuevaLinea.querySelector('.btn-personalizar');
    if (btnPersonalizar) {
        btnPersonalizar.style.background = '#95a5a6';
        btnPersonalizar.style.opacity = '0.7';
    }
    
    // Actualizar n√∫mero
    renumerarPrendas();
    
    container.appendChild(nuevaLinea);
}

function renumerarPrendas() {
    const todasLineas = document.querySelectorAll('.linea-pedido-row');
    todasLineas.forEach((linea, index) => {
        const numero = linea.querySelector('.linea-pedido-numero');
        if (numero) {
            numero.textContent = `#${index + 1}`;
        }
    });
}

function eliminarLinea(btn) {
    const lineas = document.querySelectorAll('.linea-pedido-row');
    if (lineas.length > 1) {
        btn.closest('.linea-pedido-row').remove();
        renumerarPrendas();
    } else {
        alert('Debe haber al menos una prenda en el pedido');
    }
}

function togglePersonalizar(btn) {
    const lineaRow = btn.closest('.linea-pedido-row');
    const camposPersonalizados = lineaRow.querySelectorAll('.campo-personalizado');
    
    if (camposPersonalizados.length === 0) {
        return;
    }
    
    // Verificar si los campos est√°n visibles
    const primerCampo = camposPersonalizados[0];
    const estaActivo = primerCampo.style.display !== 'none' && 
                       window.getComputedStyle(primerCampo).display !== 'none';
    
    camposPersonalizados.forEach(campo => {
        if (estaActivo) {
            campo.style.display = 'none';
        } else {
            campo.style.display = 'block';
        }
    });
    
    // Actualizar estado visual del bot√≥n
    if (estaActivo) {
        btn.style.background = '#95a5a6';
        btn.style.opacity = '0.7';
        btn.classList.remove('active');
    } else {
        btn.style.background = '#3498db';
        btn.style.opacity = '1';
        btn.classList.add('active');
    }
}

function duplicarLinea(btn) {
    const lineaRow = btn.closest('.linea-pedido-row');
    const nuevaLinea = lineaRow.cloneNode(true);
    const container = document.getElementById('prendas-container');
    
    // Limpiar talla y unidades
    const tallaInput = nuevaLinea.querySelector('input[name="talla[]"]');
    const unidadesInput = nuevaLinea.querySelector('input[name="cantidad[]"]');
    
    if (tallaInput) {
        tallaInput.value = '';
    }
    if (unidadesInput) {
        unidadesInput.value = '1';
    }
    
    // Mantener el estado de los campos personalizados
    const camposPersonalizados = nuevaLinea.querySelectorAll('.campo-personalizado');
    const btnPersonalizar = nuevaLinea.querySelector('.btn-personalizar');
    const estaActivo = camposPersonalizados[0] && camposPersonalizados[0].style.display !== 'none';
    
    if (estaActivo && camposPersonalizados.length > 0) {
        camposPersonalizados.forEach(campo => {
            campo.style.display = 'block';
        });
        if (btnPersonalizar) {
            btnPersonalizar.style.background = '#3498db';
            btnPersonalizar.style.opacity = '1';
            btnPersonalizar.classList.add('active');
        }
    } else {
        camposPersonalizados.forEach(campo => {
            campo.style.display = 'none';
        });
        if (btnPersonalizar) {
            btnPersonalizar.style.background = '#95a5a6';
            btnPersonalizar.style.opacity = '0.7';
            btnPersonalizar.classList.remove('active');
        }
    }
    
    // Actualizar n√∫mero
    renumerarPrendas();
    
    // Insertar despu√©s de la l√≠nea actual
    lineaRow.parentNode.insertBefore(nuevaLinea, lineaRow.nextSibling);
    renumerarPrendas();
}
</script>
{% endblock %}

