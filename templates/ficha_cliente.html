{% extends "base.html" %}

{% block title %}Ficha Cliente - {{ cliente.nombre }}{% endblock %}

{% block content %}
<div class="ficha-cliente-container">
    <div class="ficha-header">
        <h2>üìã Ficha del Cliente: {{ cliente.nombre }}</h2>
        <div class="ficha-actions">
            <a href="{{ url_for('clientes.editar_cliente', id=cliente.id) }}" class="btn btn-primary">‚úèÔ∏è Editar Cliente</a>
            <form method="POST" action="{{ url_for('clientes.eliminar_cliente', id=cliente.id) }}" style="display: inline;" onsubmit="return confirm('¬øEst√° seguro de eliminar este cliente? Esta acci√≥n no se puede deshacer.');">
                <button type="submit" class="btn btn-danger">üóëÔ∏è Eliminar Cliente</button>
            </form>
            <a href="{{ url_for('clientes.gestion_clientes') }}" class="btn btn-secondary">‚Üê Volver a Lista</a>
        </div>
    </div>

    <div class="ficha-grid">
        <!-- Informaci√≥n Principal -->
        <div class="ficha-section">
            <h3>Informaci√≥n Principal</h3>
            <div class="info-grid">
                <div class="info-item">
                    <strong>Nombre:</strong>
                    <span>{{ cliente.nombre }}</span>
                </div>
                {% if cliente.alias %}
                <div class="info-item">
                    <strong>Alias:</strong>
                    <span>{{ cliente.alias }}</span>
                </div>
                {% endif %}
                <div class="info-item">
                    <strong>NIF/CIF:</strong>
                    <span>{{ cliente.nif or '-' }}</span>
                </div>
                <div class="info-item">
                    <strong>Tel√©fono:</strong>
                    <span>{{ cliente.telefono or '-' }}</span>
                </div>
                <div class="info-item">
                    <strong>M√≥vil:</strong>
                    <span>{{ cliente.movil or '-' }}</span>
                </div>
                <div class="info-item">
                    <strong>Email General:</strong>
                    <span>{{ cliente.email_general or '-' }}</span>
                </div>
                <div class="info-item">
                    <strong>Email Comunicaciones:</strong>
                    <span>{{ cliente.email_comunicaciones or '-' }}</span>
                </div>
                <div class="info-item">
                    <strong>Categor√≠a:</strong>
                    <span>{{ cliente.categoria_obj.nombre if cliente.categoria_obj else '-' }}</span>
                </div>
                {% if cliente.comercial %}
                <div class="info-item">
                    <strong>Comercial Asignado:</strong>
                    <span>{{ cliente.comercial.nombre }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Direcci√≥n Principal -->
        <div class="ficha-section">
            <h3>Direcci√≥n Principal</h3>
            <div class="info-grid">
                <div class="info-item full-width">
                    <strong>Direcci√≥n:</strong>
                    <span>{{ cliente.direccion or '-' }}</span>
                </div>
                <div class="info-item">
                    <strong>Poblaci√≥n:</strong>
                    <span>{{ cliente.poblacion or '-' }}</span>
                </div>
                <div class="info-item">
                    <strong>Provincia:</strong>
                    <span>{{ cliente.provincia or '-' }}</span>
                </div>
                <div class="info-item">
                    <strong>C√≥digo Postal:</strong>
                    <span>{{ cliente.codigo_postal or '-' }}</span>
                </div>
                <div class="info-item">
                    <strong>Pa√≠s:</strong>
                    <span>{{ cliente.pais or 'Espa√±a' }}</span>
                </div>
            </div>
        </div>

        <!-- Direcciones de Env√≠o Alternativas -->
        <div class="ficha-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">Direcciones de Env√≠o Alternativas</h3>
                <button onclick="abrirModalDirecciones()" class="btn btn-sm btn-primary">‚ûï Gestionar Direcciones</button>
            </div>
            {% if cliente.direcciones_envio %}
                {% for direccion in cliente.direcciones_envio %}
                <div style="border: 1px solid #e0e0e0; padding: 12px; margin-bottom: 10px; border-radius: 5px; background: #f9f9f9;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #555;">{{ direccion.nombre }}</h4>
                    <div class="info-grid">
                        {% if direccion.direccion %}
                        <div class="info-item full-width">
                            <strong>Direcci√≥n:</strong>
                            <span>{{ direccion.direccion }}</span>
                        </div>
                        {% endif %}
                        {% if direccion.poblacion %}
                        <div class="info-item">
                            <strong>Poblaci√≥n:</strong>
                            <span>{{ direccion.poblacion }}</span>
                        </div>
                        {% endif %}
                        {% if direccion.provincia %}
                        <div class="info-item">
                            <strong>Provincia:</strong>
                            <span>{{ direccion.provincia }}</span>
                        </div>
                        {% endif %}
                        {% if direccion.codigo_postal %}
                        <div class="info-item">
                            <strong>C√≥digo Postal:</strong>
                            <span>{{ direccion.codigo_postal }}</span>
                        </div>
                        {% endif %}
                        {% if direccion.pais %}
                        <div class="info-item">
                            <strong>Pa√≠s:</strong>
                            <span>{{ direccion.pais }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="color: #999; font-style: italic; margin: 0;">No hay direcciones de env√≠o alternativas registradas.</p>
            {% endif %}
        </div>

        <!-- Anotaciones -->
        <div class="ficha-section">
            <h3>Anotaciones</h3>
            {% if cliente.personas_contacto %}
            <div style="margin-bottom: 12px;">
                <strong style="color: #555; font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Personas de Contacto:</strong>
                <div class="info-text-enmarcado">
                    {{ cliente.personas_contacto | nl2br }}
                </div>
            </div>
            {% endif %}
            {% if cliente.anotaciones %}
            <div class="info-text-enmarcado">
                {{ cliente.anotaciones | nl2br }}
            </div>
            {% else %}
            <div class="info-text-enmarcado" style="color: #999; font-style: italic;">
                Sin anotaciones
            </div>
            {% endif %}
            <div class="info-grid" style="margin-top: 12px;">
                {% if cliente.fecha_alta %}
                <div class="info-item">
                    <strong>Fecha de Alta:</strong>
                    <span>{{ cliente.fecha_alta.strftime('%d/%m/%Y') }}</span>
                </div>
                {% endif %}
                <div class="info-item">
                    <strong>Acceso Web:</strong>
                    <span>
                        {% if cliente.tiene_acceso_web() %}
                            <span style="color: #28a745; font-weight: 600;">‚úì Configurado</span> (Usuario: {{ cliente.usuario_web }})
                        {% else %}
                            <span style="color: #dc3545;">‚úó No configurado</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial -->
    <div class="historial-section">
        <h3>üìä Historial</h3>
        
        <!-- Presupuestos -->
        <div class="historial-subsection">
            <h4>Presupuestos ({{ presupuestos|length }})</h4>
            {% if presupuestos %}
            <table class="historial-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for presupuesto in presupuestos %}
                    <tr>
                        <td>{{ presupuesto.id }}</td>
                        <td>{{ presupuesto.fecha_creacion.strftime('%d/%m/%Y') if presupuesto.fecha_creacion else '-' }}</td>
                        <td><span class="badge badge-{{ presupuesto.estado|lower|replace(' ', '-') }}">{{ presupuesto.estado }}</span></td>
                        <td>{{ presupuesto.tipo_pedido }}</td>
                        <td>
                            <a href="{{ url_for('solicitudes.ver_solicitud', solicitud_id=presupuesto.id) }}" class="btn btn-sm btn-primary">Ver</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No hay presupuestos registrados.</p>
            {% endif %}
        </div>

        <!-- Pedidos -->
        <div class="historial-subsection">
            <h4>Pedidos ({{ pedidos|length }})</h4>
            {% if pedidos %}
            <table class="historial-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pedido in pedidos %}
                    <tr>
                        <td>{{ pedido.id }}</td>
                        <td>{{ pedido.fecha_creacion.strftime('%d/%m/%Y') if pedido.fecha_creacion else '-' }}</td>
                        <td><span class="badge badge-{{ pedido.estado|lower|replace(' ', '-') }}">{{ pedido.estado }}</span></td>
                        <td>{{ pedido.tipo_pedido }}</td>
                        <td>
                            <a href="{{ url_for('solicitudes.ver_solicitud', solicitud_id=pedido.id) }}" class="btn btn-sm btn-primary">Ver</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No hay pedidos registrados.</p>
            {% endif %}
        </div>

        <!-- Facturas -->
        <div class="historial-subsection">
            <h4>Facturas ({{ facturas|length }})</h4>
            {% if facturas %}
            <table class="historial-table">
                <thead>
                    <tr>
                        <th>N√∫mero</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Importe</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for factura in facturas %}
                    <tr>
                        <td>{{ factura.serie }}-{{ factura.numero }}</td>
                        <td>{{ factura.fecha_expedicion.strftime('%d/%m/%Y') if factura.fecha_expedicion else '-' }}</td>
                        <td><span class="badge badge-{{ factura.estado|lower }}">{{ factura.estado }}</span></td>
                        <td>{{ "%.2f"|format(factura.importe_total) }} ‚Ç¨</td>
                        <td>
                            <a href="{{ url_for('facturacion.imprimir_factura', factura_id=factura.id) }}" class="btn btn-sm btn-primary">Ver</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No hay facturas registradas.</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
.ficha-cliente-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 15px;
}

.ficha-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e0e0e0;
}

.ficha-header h2 {
    margin: 0;
    font-size: 20px;
}

.ficha-actions {
    display: flex;
    gap: 8px;
}

.ficha-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

.ficha-section {
    background: white;
    padding: 12px 15px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.ficha-section h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #2c3e50;
    font-size: 15px;
    border-bottom: 2px solid #667eea;
    padding-bottom: 6px;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 8px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.info-item.full-width {
    grid-column: 1 / -1;
}

.info-item strong {
    color: #555;
    font-size: 12px;
    font-weight: 600;
}

.info-item span {
    color: #333;
    font-size: 13px;
}

.info-text {
    color: #333;
    line-height: 1.4;
    font-size: 13px;
    white-space: pre-wrap;
    margin: 0;
}

.info-text-enmarcado {
    color: #333;
    line-height: 1.5;
    font-size: 13px;
    white-space: pre-wrap;
    margin: 0;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    background: #f8f9fa;
    min-height: 60px;
}

.historial-section {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.historial-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #2c3e50;
    font-size: 16px;
    border-bottom: 2px solid #667eea;
    padding-bottom: 6px;
}

.historial-subsection {
    margin-bottom: 20px;
}

.historial-subsection h4 {
    color: #555;
    font-size: 14px;
    margin-bottom: 10px;
    margin-top: 0;
}

.historial-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.historial-table th,
.historial-table td {
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
    font-size: 13px;
}

.historial-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #555;
    font-size: 12px;
}

.badge {
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: capitalize;
}

.badge-pendiente { background: #ffc107; color: #000; }
.badge-enviado { background: #17a2b8; color: white; }
.badge-aceptado { background: #28a745; color: white; }
.badge-rechazado { background: #dc3545; color: white; }
.badge-confirmado { background: #28a745; color: white; }
.badge-enviado { background: #17a2b8; color: white; }

.no-data {
    color: #999;
    font-style: italic;
    padding: 20px;
    text-align: center;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
}
</style>

<!-- Modal para gestionar direcciones de env√≠o -->
<div id="modalDirecciones" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>Gestionar Direcciones de Env√≠o</h3>
            <span class="close" onclick="cerrarModalDirecciones()">&times;</span>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <div id="direcciones-lista">
                {% for direccion in cliente.direcciones_envio %}
                <div class="direccion-item" data-id="{{ direccion.id }}" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: #f9f9f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; font-size: 14px; color: #555;">{{ direccion.nombre }}</h4>
                        <div>
                            <button onclick="editarDireccion({{ direccion.id }})" class="btn btn-sm btn-primary" style="margin-right: 5px;">‚úèÔ∏è Editar</button>
                            <form method="POST" action="{{ url_for('clientes.gestionar_direcciones_envio', cliente_id=cliente.id) }}" style="display: inline;" onsubmit="return confirm('¬øEst√° seguro de eliminar esta direcci√≥n?');">
                                <input type="hidden" name="accion" value="eliminar">
                                <input type="hidden" name="direccion_id" value="{{ direccion.id }}">
                                <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è Eliminar</button>
                            </form>
                        </div>
                    </div>
                    <div class="info-grid">
                        <div class="info-item full-width">
                            <strong>Direcci√≥n:</strong>
                            <span>{{ direccion.direccion or '-' }}</span>
                        </div>
                        <div class="info-item">
                            <strong>Poblaci√≥n:</strong>
                            <span>{{ direccion.poblacion or '-' }}</span>
                        </div>
                        <div class="info-item">
                            <strong>Provincia:</strong>
                            <span>{{ direccion.provincia or '-' }}</span>
                        </div>
                        <div class="info-item">
                            <strong>C√≥digo Postal:</strong>
                            <span>{{ direccion.codigo_postal or '-' }}</span>
                        </div>
                        <div class="info-item">
                            <strong>Pa√≠s:</strong>
                            <span>{{ direccion.pais or 'Espa√±a' }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Formulario para a√±adir/editar direcci√≥n -->
            <div id="form-direccion" style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                <h4 id="form-titulo" style="margin-bottom: 15px;">A√±adir Nueva Direcci√≥n</h4>
                <form method="POST" action="{{ url_for('clientes.gestionar_direcciones_envio', cliente_id=cliente.id) }}" id="formDireccion">
                    <input type="hidden" name="accion" id="accion_form" value="crear">
                    <input type="hidden" name="direccion_id" id="direccion_id_form">
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="nombre_direccion">Nombre de la Direcci√≥n *</label>
                        <input type="text" name="nombre" id="nombre_direccion" required placeholder="Ej: Direcci√≥n env√≠o 2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="direccion_texto">Direcci√≥n</label>
                        <textarea name="direccion" id="direccion_texto" rows="2" placeholder="Direcci√≥n completa" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="poblacion_direccion">Poblaci√≥n</label>
                            <input type="text" name="poblacion" id="poblacion_direccion" placeholder="Ciudad" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label for="provincia_direccion">Provincia</label>
                            <input type="text" name="provincia" id="provincia_direccion" placeholder="Provincia" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="codigo_postal_direccion">C√≥digo Postal</label>
                            <input type="text" name="codigo_postal" id="codigo_postal_direccion" placeholder="28001" maxlength="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label for="pais_direccion">Pa√≠s</label>
                            <input type="text" name="pais" id="pais_direccion" placeholder="Espa√±a" value="Espa√±a" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" id="btn-submit-form">A√±adir Direcci√≥n</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelarEdicion()" id="btn-cancelar" style="display: none;">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const direcciones = {
    {% for direccion in cliente.direcciones_envio %}
    {{ direccion.id }}: {
        nombre: {{ direccion.nombre|tojson }},
        direccion: {{ direccion.direccion|tojson if direccion.direccion else '""' }},
        poblacion: {{ direccion.poblacion|tojson if direccion.poblacion else '""' }},
        provincia: {{ direccion.provincia|tojson if direccion.provincia else '""' }},
        codigo_postal: {{ direccion.codigo_postal|tojson if direccion.codigo_postal else '""' }},
        pais: {{ direccion.pais|tojson if direccion.pais else '"Espa√±a"' }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function abrirModalDirecciones() {
    document.getElementById('modalDirecciones').style.display = 'block';
    document.body.style.overflow = 'hidden';
    cancelarEdicion();
}

function cerrarModalDirecciones() {
    document.getElementById('modalDirecciones').style.display = 'none';
    document.body.style.overflow = 'auto';
    cancelarEdicion();
}

function editarDireccion(id) {
    const direccion = direcciones[id];
    if (!direccion) return;
    
    document.getElementById('accion_form').value = 'editar';
    document.getElementById('direccion_id_form').value = id;
    document.getElementById('nombre_direccion').value = direccion.nombre;
    document.getElementById('direccion_texto').value = direccion.direccion || '';
    document.getElementById('poblacion_direccion').value = direccion.poblacion || '';
    document.getElementById('provincia_direccion').value = direccion.provincia || '';
    document.getElementById('codigo_postal_direccion').value = direccion.codigo_postal || '';
    document.getElementById('pais_direccion').value = direccion.pais || 'Espa√±a';
    document.getElementById('form-titulo').textContent = 'Editar Direcci√≥n';
    document.getElementById('btn-submit-form').textContent = 'Guardar Cambios';
    document.getElementById('btn-cancelar').style.display = 'block';
    
    // Scroll al formulario
    document.getElementById('form-direccion').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function cancelarEdicion() {
    document.getElementById('accion_form').value = 'crear';
    document.getElementById('direccion_id_form').value = '';
    document.getElementById('formDireccion').reset();
    document.getElementById('pais_direccion').value = 'Espa√±a';
    document.getElementById('form-titulo').textContent = 'A√±adir Nueva Direcci√≥n';
    document.getElementById('btn-submit-form').textContent = 'A√±adir Direcci√≥n';
    document.getElementById('btn-cancelar').style.display = 'none';
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const modal = document.getElementById('modalDirecciones');
    if (event.target == modal) {
        cerrarModalDirecciones();
    }
}

// Cerrar modal con ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        cerrarModalDirecciones();
    }
});
</script>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    overflow-y: auto;
}

.modal-content {
    background-color: white;
    margin: 3% auto;
    padding: 0;
    border-radius: 10px;
    max-width: 700px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 2px solid #e0e0e0;
    background: #f8f9fa;
    border-radius: 10px 10px 0 0;
}

.modal-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 18px;
}

.modal-body {
    padding: 20px;
}

.close {
    color: #aaa;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover,
.close:focus {
    color: #000;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 4px;
    font-weight: 500;
    color: #555;
    font-size: 13px;
}
</style>
{% endblock %}

