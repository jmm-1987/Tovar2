{% extends "base.html" %}

{% block title %}Panel de Control - Gestión de Pedidos{% endblock %}

{% block content %}
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
    <h2 style="font-size: 1.5rem; margin: 0;">PANEL DE CONTROL</h2>
    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <form method="GET" action="{{ url_for('index.index') }}" style="display: inline-block; margin: 0;">
            <select name="filtro" id="filtro" onchange="this.form.submit()" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.8rem; background: white; color: #495057; cursor: pointer; margin-right: 10px;">
                <option value="">Todos</option>
                <option value="solo_mockup" {% if filtro_activo == 'solo_mockup' %}selected{% endif %}>Solo Mockup</option>
                <option value="solo_en_preparacion" {% if filtro_activo == 'solo_en_preparacion' %}selected{% endif %}>Solo En Preparación</option>
            </select>
        </form>
        <a href="{{ url_for('solicitudes.nueva_solicitud') }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem;">Nueva Solicitud</a>
    </div>
</div>

{% if solicitudes %}
<div class="pedidos-grid">
    {% for solicitud in solicitudes %}
    <div class="pedido-card {% if solicitud.fecha_class %}pedido-{{ solicitud.fecha_class }}{% endif %}">
        <div class="pedido-card-header">
            <div class="pedido-id">
                Solicitud #{{ solicitud.id }}{% if solicitud.fecha_aceptado %} - {{ solicitud.fecha_aceptado.strftime('%d/%m/%Y') }}{% endif %}
            </div>
            <span class="badge badge-estado-{{ solicitud.estado|lower|replace(' ', '-') }}">{{ solicitud.estado|title }}</span>
        </div>
        
        <div class="pedido-card-body">
            <div class="pedido-info-item">
                <strong>Cliente:</strong>
                <span>{{ solicitud.cliente.nombre if solicitud.cliente else 'N/A' }}</span>
            </div>
            
            <div class="pedido-info-item">
                <strong>Tipo:</strong>
                <span>{{ solicitud.tipo_pedido|title }}</span>
            </div>
            
            <div class="pedido-info-item">
                <strong>Fecha Objetivo:</strong>
                <span>
                    {% if solicitud.fecha_objetivo %}
                        <span class="fecha-objetivo {{ solicitud.fecha_class }}">
                            {{ solicitud.fecha_objetivo.strftime('%d/%m/%Y') }}
                        </span>
                    {% else %}
                        -
                    {% endif %}
                </span>
            </div>
            
            {% if solicitud.estado == 'mockup' and solicitud.fecha_limite_mockup and hoy is defined %}
            <div class="pedido-info-item">
                <strong>Fecha Límite Mockup:</strong>
                <span>
                    {% set dias_restantes = (solicitud.fecha_limite_mockup - hoy).days %}
                    <span class="fecha-limite-mockup {% if dias_restantes < 0 %}urgente{% elif dias_restantes <= 1 %}proxima{% else %}ok{% endif %}">
                        {{ solicitud.fecha_limite_mockup.strftime('%d/%m/%Y') }}
                        {% if dias_restantes < 0 %}
                            <span style="color: #dc3545; font-weight: bold;">(Vencido)</span>
                        {% elif dias_restantes == 0 %}
                            <span style="color: #ffc107; font-weight: bold;">(Hoy)</span>
                        {% elif dias_restantes <= 1 %}
                            <span style="color: #ffc107;">({{ dias_restantes }} día)</span>
                        {% else %}
                            <span style="color: #28a745;">({{ dias_restantes }} días)</span>
                        {% endif %}
                    </span>
                </span>
            </div>
            {% endif %}
            
            <div class="pedido-info-item">
                <strong>Estado:</strong>
                <span class="badge badge-estado-{{ solicitud.estado|lower|replace(' ', '-') }}" style="padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                    {{ solicitud.estado|title }}
                </span>
            </div>
            
            {% if solicitud.subestado %}
            <div class="pedido-info-item">
                <strong>Subestado:</strong>
                <span class="badge badge-estado-{{ solicitud.subestado|lower|replace(' ', '-') }}" style="padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: #28a745; color: white;">
                    {{ solicitud.subestado|title }}
                </span>
            </div>
            {% endif %}
        </div>
        
        <div class="pedido-card-actions">
            <a href="{{ url_for('solicitudes.ver_solicitud', solicitud_id=solicitud.id) }}" class="btn btn-info">Ver</a>
            <a href="{{ url_for('solicitudes.descargar_pdf_solicitud', solicitud_id=solicitud.id) }}" class="btn btn-warning" target="_blank">Imprimir</a>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>No hay solicitudes activas. <a href="{{ url_for('solicitudes.nueva_solicitud') }}">Crear primera solicitud</a></p>
{% endif %}
{% endblock %}
