{% extends "base.html" %}

{% block title %}Facturar Albaranes - {{ cliente.nombre }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px; margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2>Facturar Albaranes</h2>
            <p style="color: #666; margin: 5px 0;">Cliente: <strong>{{ cliente.nombre }}</strong>{% if cliente.nif %} - {{ cliente.nif }}{% endif %}</p>
        </div>
        <a href="{{ url_for('facturacion.facturar_albaranes') }}" class="btn btn-secondary" style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; display: inline-block;">
            ‚Üê Cambiar Cliente
        </a>
    </div>
    
    <form method="POST" action="{{ url_for('facturacion.procesar_facturacion_albaranes') }}" id="facturarForm">
        <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
        
        <!-- Informaci√≥n de la factura -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
            <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 1.2rem;">Datos de la Factura</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="fecha_expedicion" style="font-weight: 600; margin-bottom: 5px; display: block;">Fecha de Expedici√≥n *</label>
                    <input type="date" name="fecha_expedicion" id="fecha_expedicion" required class="form-control" value="{{ fecha_hoy }}" style="width: 100%; padding: 8px;">
                </div>
                <div class="form-group">
                    <label for="descuento_pronto_pago" style="font-weight: 600; margin-bottom: 5px; display: block;">Descuento por Pronto Pago (%)</label>
                    <input type="number" name="descuento_pronto_pago" id="descuento_pronto_pago" step="0.01" min="0" max="100" value="0" class="form-control" style="width: 100%; padding: 8px;">
                </div>
                <div class="form-group">
                    <label for="descripcion" style="font-weight: 600; margin-bottom: 5px; display: block;">Descripci√≥n</label>
                    <input type="text" name="descripcion" id="descripcion" class="form-control" placeholder="Descripci√≥n de la operaci√≥n" style="width: 100%; padding: 8px;">
                </div>
            </div>
        </div>
        
        <!-- Lista de albaranes -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 1.2rem;">Albaranes Pendientes ({{ albaranes|length }})</h3>
                <div>
                    <button type="button" onclick="seleccionarTodos()" class="btn btn-sm btn-secondary" style="padding: 6px 12px; margin-right: 5px;">Seleccionar Todos</button>
                    <button type="button" onclick="deseleccionarTodos()" class="btn btn-sm btn-secondary" style="padding: 6px 12px;">Deseleccionar Todos</button>
                </div>
            </div>
            
            {% if albaranes %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 12px; text-align: left; width: 40px;">
                            <input type="checkbox" id="selectAll" onchange="toggleTodos(this.checked)">
                        </th>
                        <th style="padding: 12px; text-align: left;">N√∫mero</th>
                        <th style="padding: 12px; text-align: left;">Fecha</th>
                        <th style="padding: 12px; text-align: right;">Importe Total</th>
                        <th style="padding: 12px; text-align: center;">L√≠neas</th>
                        <th style="padding: 12px; text-align: left;">Descripci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for albaran in albaranes %}
                    <tr style="border-bottom: 1px solid #e9ecef;" class="albaran-row">
                        <td style="padding: 12px;">
                            <input type="checkbox" name="albaranes_seleccionados[]" value="{{ albaran.id }}" class="albaran-checkbox" onchange="actualizarTotal()">
                        </td>
                        <td style="padding: 12px; font-weight: 600;">{{ albaran.numero }}</td>
                        <td style="padding: 12px;">{{ albaran.fecha_expedicion.strftime('%d/%m/%Y') if albaran.fecha_expedicion else 'N/A' }}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">
                            {{ "%.2f"|format(albaran.importe_total) if albaran.importe_total else "0.00" }} ‚Ç¨
                        </td>
                        <td style="padding: 12px; text-align: center;">{{ albaran.lineas|length }}</td>
                        <td style="padding: 12px; color: #666;">{{ albaran.descripcion or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr style="background: #f8f9fa; border-top: 2px solid #dee2e6; font-weight: 600;">
                        <td colspan="3" style="padding: 12px; text-align: right;">Total Seleccionado:</td>
                        <td id="totalSeleccionado" style="padding: 12px; text-align: right; color: #007bff; font-size: 1.1rem;">0.00 ‚Ç¨</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
            {% else %}
            <p style="padding: 40px; text-align: center; color: #999;">No hay albaranes pendientes para este cliente.</p>
            {% endif %}
        </div>
        
        <!-- Botones de acci√≥n -->
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <a href="{{ url_for('facturacion.facturar_albaranes') }}" class="btn btn-secondary" style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; display: inline-block;">
                Cancelar
            </a>
            <button type="submit" class="btn btn-success" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;" onclick="return validarSeleccion()">
                üßæ Facturar Albaranes Seleccionados
            </button>
        </div>
    </form>
</div>

<script>
function toggleTodos(checked) {
    const checkboxes = document.querySelectorAll('.albaran-checkbox');
    checkboxes.forEach(cb => cb.checked = checked);
    actualizarTotal();
}

function seleccionarTodos() {
    document.getElementById('selectAll').checked = true;
    toggleTodos(true);
}

function deseleccionarTodos() {
    document.getElementById('selectAll').checked = false;
    toggleTodos(false);
}

function actualizarTotal() {
    const checkboxes = document.querySelectorAll('.albaran-checkbox:checked');
    let total = 0;
    
    checkboxes.forEach(cb => {
        const row = cb.closest('tr');
        const importeText = row.querySelector('td:nth-child(4)').textContent.trim();
        const importe = parseFloat(importeText.replace('‚Ç¨', '').replace(/\s/g, '').replace(',', '.'));
        if (!isNaN(importe)) {
            total += importe;
        }
    });
    
    document.getElementById('totalSeleccionado').textContent = total.toFixed(2) + ' ‚Ç¨';
}

function validarSeleccion() {
    const checkboxes = document.querySelectorAll('.albaran-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Debe seleccionar al menos un albar√°n para facturar');
        return false;
    }
    return confirm(`¬øEst√° seguro de que desea facturar ${checkboxes.length} albar√°n(es)?`);
}

// Actualizar total al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    actualizarTotal();
});
</script>

<style>
.albaran-row:hover {
    background-color: #f8f9fa;
}

.albaran-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.btn-sm {
    font-size: 0.875rem;
}
</style>
{% endblock %}

