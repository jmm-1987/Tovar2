{% extends "base.html" %}

{% block title %}Editar Albarán{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px; margin-top: 10px;">
    <form method="POST" id="albaranForm">
        <!-- Título y campos principales en la misma línea -->
        <div style="display: flex; align-items: flex-end; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;">
            <h2 style="margin: 0; flex: 0 0 auto;">Editar Albarán - {{ factura.numero }}</h2>
            
            <div class="form-group" style="flex: 0 0 180px;">
                <label for="fecha_expedicion">Fecha de Expedición *</label>
                <input type="date" name="fecha_expedicion" id="fecha_expedicion" value="{{ fecha_hoy }}" required class="form-control" style="width: 100%;">
            </div>
            
            <div class="form-group" style="flex: 1 1 250px; min-width: 250px;">
                <label for="cliente_id">Cliente (AUTOCOMPLETAR)</label>
                <select name="cliente_id" id="cliente_id" class="form-control" onchange="cargarDatosCliente()" style="width: 100%;">
                    <option value="">Seleccionar cliente...</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id }}" 
                            {% if cliente_seleccionado and cliente.id == cliente_seleccionado.id %}selected{% endif %}
                            data-nombre="{{ cliente.nombre }}" 
                            data-nif="{{ cliente.nif or '' }}"
                            data-direccion="{{ cliente.direccion or '' }}"
                            data-poblacion="{{ cliente.poblacion or '' }}"
                            data-provincia="{{ cliente.provincia or '' }}"
                            data-codigo-postal="{{ cliente.codigo_postal or '' }}"
                            data-telefono="{{ cliente.telefono or '' }}"
                            data-email="{{ cliente.email or '' }}">{{ cliente.nombre }}{% if cliente.nif %} - {{ cliente.nif }}{% endif %}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Datos del cliente -->
        <h3 style="margin-top: 10px; margin-bottom: 8px; font-size: 1.1rem;">Datos del Cliente</h3>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 8px;">
            <div class="form-group">
                <label for="nombre_cliente">Nombre del Cliente *</label>
                <input type="text" name="nombre_cliente" id="nombre_cliente" value="{{ factura.nombre or '' }}" required class="form-control" placeholder="Nombre completo del cliente" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label for="nif_cliente">NIF/CIF del Cliente *</label>
                <input type="text" name="nif_cliente" id="nif_cliente" value="{{ factura.nif or '' }}" required class="form-control" placeholder="NIF o CIF" style="width: 100%;">
            </div>
        </div>
        
        <div class="form-group" style="margin-bottom: 8px;">
            <label for="direccion_cliente">Dirección *</label>
            <input type="text" name="direccion_cliente" id="direccion_cliente" value="{{ datos_cliente.direccion or '' }}" required class="form-control" placeholder="Dirección completa" style="width: 100%;">
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 8px;">
            <div class="form-group">
                <label for="poblacion_cliente">Población *</label>
                <input type="text" name="poblacion_cliente" id="poblacion_cliente" value="{{ datos_cliente.poblacion or '' }}" required class="form-control" placeholder="Población" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label for="provincia_cliente">Provincia *</label>
                <input type="text" name="provincia_cliente" id="provincia_cliente" value="{{ datos_cliente.provincia or '' }}" required class="form-control" placeholder="Provincia" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label for="codigo_postal_cliente">Código Postal *</label>
                <input type="text" name="codigo_postal_cliente" id="codigo_postal_cliente" value="{{ datos_cliente.codigo_postal or '' }}" required class="form-control" placeholder="CP" style="width: 100%;">
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <div class="form-group">
                <label for="telefono_cliente">Teléfono</label>
                <input type="text" name="telefono_cliente" id="telefono_cliente" value="{{ datos_cliente.telefono or '' }}" class="form-control" placeholder="Teléfono" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label for="email_cliente">Email</label>
                <input type="email" name="email_cliente" id="email_cliente" value="{{ datos_cliente.email or '' }}" class="form-control" placeholder="Email" style="width: 100%;">
            </div>
        </div>
        
        <div class="form-group" style="margin-bottom: 10px;">
            <label for="descripcion">Descripción de la Operación</label>
            <textarea name="descripcion" id="descripcion" rows="2" class="form-control" placeholder="Descripción general del albarán" style="width: 100%; max-width: 520px;">{{ factura.descripcion or '' }}</textarea>
        </div>
        
        <h3 style="margin-top: 10px; margin-bottom: 8px; font-size: 1.1rem;">Líneas del Albarán</h3>
        <!-- Cabeceras de las columnas -->
        <div class="linea-factura-header">
            <div class="linea-factura-numero-header">#</div>
            <div class="linea-factura-campos-header">
                <div class="header-col" style="flex: 1; min-width: 500px;">Descripción</div>
                <div class="header-col" style="flex: 0 0 80px; width: 80px;">Cant.</div>
                <div class="header-col" style="flex: 0 0 80px; width: 80px;">Talla</div>
                <div class="header-col" style="flex: 0 0 100px; width: 100px;">P. Unit.</div>
                <div class="header-col" style="flex: 0 0 80px; width: 80px;">Desc. %</div>
                <div class="header-col" style="flex: 0 0 100px; width: 100px;">P. Final</div>
                <div class="header-col" style="flex: 0 0 100px; width: 100px; text-align: right;">Importe</div>
                <div class="header-col" style="flex: 0 0 30px; width: 30px;"></div>
            </div>
        </div>
        <div id="lineas-container">
            {% if factura.lineas %}
                {% for linea in factura.lineas %}
                <div class="linea-factura-row">
                    <div class="linea-factura-numero">#{{ loop.index }}</div>
                    <div class="linea-factura-campos">
                        <input type="text" name="descripcion_linea[]" value="{{ linea.descripcion or '' }}" placeholder="Descripción" required class="linea-campo-compact" style="flex: 1; min-width: 500px;">
                        <input type="number" name="cantidad[]" value="{{ "%.2f"|format(linea.cantidad) if linea.cantidad else '1' }}" placeholder="Cant." step="0.01" min="0" required class="linea-campo-compact linea-cantidad" style="flex: 0 0 80px; width: 80px;">
                        <input type="text" name="talla[]" value="{{ linea.talla or '' }}" placeholder="Talla" class="linea-campo-compact" style="flex: 0 0 80px; width: 80px;">
                        <input type="number" name="precio_unitario[]" value="{{ "%.2f"|format(linea.precio_unitario) if linea.precio_unitario else '0' }}" placeholder="P. Unit." step="0.01" min="0" required class="linea-campo-compact precio-unitario" style="flex: 0 0 100px; width: 100px;">
                        <input type="number" name="descuento[]" value="{{ "%.2f"|format(linea.descuento) if linea.descuento else '0' }}" class="linea-campo-compact descuento-input" step="0.01" min="0" max="100" placeholder="Desc. %" title="Descuento (%)" style="flex: 0 0 80px; width: 80px;">
                        <input type="number" name="precio_final[]" value="{{ "%.2f"|format(linea.precio_final) if linea.precio_final else '' }}" class="linea-campo-compact precio-final-input" step="0.01" min="0" placeholder="P. Final" title="Precio Final" readonly style="flex: 0 0 100px; width: 100px; background: #f0f0f0;">
                        <span class="importe-linea" style="flex: 0 0 100px; padding: 8px; text-align: right; font-weight: bold;">{{ "%.2f"|format(linea.importe) if linea.importe else '0.00' }} €</span>
                        <button type="button" class="btn-eliminar-linea" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; {% if factura.lineas|length > 1 %}display: block;{% else %}display: none;{% endif %} flex: 0 0 30px;">×</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="linea-factura-row">
                <div class="linea-factura-numero">#1</div>
                <div class="linea-factura-campos">
                    <input type="text" name="descripcion_linea[]" placeholder="Descripción" required class="linea-campo-compact" style="flex: 1; min-width: 500px;">
                    <input type="number" name="cantidad[]" placeholder="Cant." step="0.01" min="0" value="1" required class="linea-campo-compact linea-cantidad" style="flex: 0 0 80px; width: 80px;">
                    <input type="text" name="talla[]" placeholder="Talla" class="linea-campo-compact" style="flex: 0 0 80px; width: 80px;">
                    <input type="number" name="precio_unitario[]" placeholder="P. Unit." step="0.01" min="0" required class="linea-campo-compact precio-unitario" style="flex: 0 0 100px; width: 100px;">
                    <input type="number" name="descuento[]" class="linea-campo-compact descuento-input" step="0.01" min="0" max="100" value="0" placeholder="Desc. %" title="Descuento (%)" style="flex: 0 0 80px; width: 80px;">
                    <input type="number" name="precio_final[]" class="linea-campo-compact precio-final-input" step="0.01" min="0" placeholder="P. Final" title="Precio Final" readonly style="flex: 0 0 100px; width: 100px; background: #f0f0f0;">
                    <span class="importe-linea" style="flex: 0 0 100px; padding: 8px; text-align: right; font-weight: bold;">0.00 €</span>
                    <button type="button" class="btn-eliminar-linea" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; display: none; flex: 0 0 30px;">×</button>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div style="margin-top: 15px;">
            <button type="button" id="agregar-linea" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;">+ Agregar Línea</button>
        </div>
        
        <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 6px; max-width: 400px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <strong>Base Imponible:</strong>
                <span id="base-imponible">0.00</span> €
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <strong>IVA (21%):</strong>
                <span id="iva-total">0.00</span> €
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-top: 10px; border-top: 1px solid #dee2e6;">
                <strong>Subtotal:</strong>
                <span id="subtotal">0.00</span> €
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                <label for="descuento_pronto_pago" style="margin: 0; font-weight: 500;">Descuento por pronto pago (%):</label>
                <input type="number" name="descuento_pronto_pago" id="descuento_pronto_pago" step="0.01" min="0" max="100" value="{{ "%.2f"|format(factura.descuento_pronto_pago) if factura.descuento_pronto_pago else '0' }}" placeholder="0" style="width: 80px; padding: 4px 8px; border: 1px solid #dee2e6; border-radius: 4px; text-align: right;">
            </div>
            <div style="display: none; justify-content: space-between; margin-bottom: 10px;" id="descuento-pronto-pago-row">
                <strong style="color: #28a745;">Descuento aplicado:</strong>
                <span id="descuento-aplicado" style="color: #28a745;">0.00</span> €
            </div>
            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid #dee2e6;">
                <strong style="font-size: 1.2rem;">Total:</strong>
                <strong style="font-size: 1.2rem;"><span id="importe-total">0.00</span> €</strong>
            </div>
        </div>
        
        <div style="margin-top: 30px; display: flex; gap: 10px;">
            <button type="submit" class="btn btn-primary" style="padding: 10px 20px;">Actualizar Albarán</button>
            <a href="{{ url_for('facturacion.facturacion', tipo_vista='pendientes') }}" class="btn btn-secondary" style="padding: 10px 20px; text-decoration: none;">Cancelar</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const lineasContainer = document.getElementById('lineas-container');
    let lineaCount = {{ factura.lineas|length if factura.lineas else 1 }};
    
    // Establecer fecha de expedición
    {% if factura.fecha_expedicion %}
    document.getElementById('fecha_expedicion').value = '{{ factura.fecha_expedicion.strftime('%Y-%m-%d') }}';
    {% endif %}
    
    // Cargar datos del cliente si hay cliente seleccionado
    {% if cliente_seleccionado %}
    document.getElementById('cliente_id').value = '{{ cliente_seleccionado.id }}';
    // Cargar datos del cliente desde la factura (puede que no coincidan exactamente con el cliente)
    {% endif %}
    
    // Función para calcular precio final con descuento
    function calcularPrecioFinal(lineaRow) {
        const precioUnitarioInput = lineaRow.querySelector('.precio-unitario');
        const descuentoInput = lineaRow.querySelector('.descuento-input');
        const precioFinalInput = lineaRow.querySelector('.precio-final-input');
        
        if (!precioUnitarioInput || !descuentoInput || !precioFinalInput) return;
        
        const precioUnitario = parseFloat(precioUnitarioInput.value) || 0;
        const descuento = parseFloat(descuentoInput.value) || 0;
        
        if (precioUnitario > 0 && descuento > 0) {
            const precioFinal = precioUnitario * (1 - descuento / 100);
            precioFinalInput.value = precioFinal.toFixed(2);
        } else {
            precioFinalInput.value = precioUnitario.toFixed(2);
        }
        
        calcularImporteLinea(lineaRow);
    }
    
    // Función para calcular importe de línea
    function calcularImporteLinea(lineaRow) {
        const cantidadInput = lineaRow.querySelector('.linea-cantidad');
        const precioFinalInput = lineaRow.querySelector('.precio-final-input');
        const precioUnitarioInput = lineaRow.querySelector('.precio-unitario');
        const importeSpan = lineaRow.querySelector('.importe-linea');
        
        const cantidad = parseFloat(cantidadInput.value) || 0;
        // Usar precio final si existe y tiene valor, sino usar precio unitario
        let precio = 0;
        if (precioFinalInput && precioFinalInput.value) {
            precio = parseFloat(precioFinalInput.value) || 0;
        } else if (precioUnitarioInput) {
            precio = parseFloat(precioUnitarioInput.value) || 0;
        }
        
        const importe = cantidad * precio;
        importeSpan.textContent = importe.toFixed(2) + ' €';
        actualizarTotales();
    }
    
    // Función para actualizar totales
    function actualizarTotales() {
        // Sumar todas las líneas (sin IVA)
        let baseImponible = 0;
        document.querySelectorAll('.importe-linea').forEach(span => {
            const texto = span.textContent.replace(' €', '').trim();
            baseImponible += parseFloat(texto) || 0;
        });
        
        // Calcular IVA (21% sobre la base imponible)
        const iva = baseImponible * 0.21;
        
        // Subtotal (base + IVA)
        const subtotal = baseImponible + iva;
        
        // Calcular descuento por pronto pago sobre el subtotal
        const descuentoProntoPago = parseFloat(document.getElementById('descuento_pronto_pago').value) || 0;
        const descuentoAplicado = subtotal * (descuentoProntoPago / 100);
        const total = subtotal - descuentoAplicado;
        
        document.getElementById('base-imponible').textContent = baseImponible.toFixed(2);
        document.getElementById('iva-total').textContent = iva.toFixed(2);
        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        
        // Mostrar/ocultar fila de descuento aplicado
        const descuentoRow = document.getElementById('descuento-pronto-pago-row');
        const descuentoAplicadoSpan = document.getElementById('descuento-aplicado');
        if (descuentoProntoPago > 0) {
            descuentoRow.style.display = 'flex';
            descuentoAplicadoSpan.textContent = descuentoAplicado.toFixed(2);
        } else {
            descuentoRow.style.display = 'none';
            descuentoAplicadoSpan.textContent = '0.00';
        }
        
        document.getElementById('importe-total').textContent = total.toFixed(2);
    }
    
    // Event listener para descuento por pronto pago
    document.getElementById('descuento_pronto_pago').addEventListener('input', function() {
        actualizarTotales();
    });
    
    // Agregar nueva línea
    document.getElementById('agregar-linea').addEventListener('click', function() {
        lineaCount++;
        const primeraLinea = lineasContainer.querySelector('.linea-factura-row');
        const nuevaLinea = primeraLinea.cloneNode(true);
        
        // Limpiar valores
        nuevaLinea.querySelectorAll('input').forEach(input => {
            if (input.type === 'number') {
                if (input.classList.contains('linea-cantidad')) {
                    input.value = '1';
                } else if (input.classList.contains('descuento-input')) {
                    input.value = '0';
                } else if (input.classList.contains('precio-final-input')) {
                    input.value = '';
                } else {
                    input.value = '';
                }
            } else {
                input.value = '';
            }
        });
        nuevaLinea.querySelector('.importe-linea').textContent = '0.00 €';
        
        // Actualizar número
        nuevaLinea.querySelector('.linea-factura-numero').textContent = '#' + lineaCount;
        
        // Mostrar botón eliminar
        nuevaLinea.querySelector('.btn-eliminar-linea').style.display = 'block';
        
        // Añadir event listeners
        const cantidadInput = nuevaLinea.querySelector('.linea-cantidad');
        const precioUnitarioInput = nuevaLinea.querySelector('.precio-unitario');
        const descuentoInput = nuevaLinea.querySelector('.descuento-input');
        const precioFinalInput = nuevaLinea.querySelector('.precio-final-input');
        
        cantidadInput.addEventListener('input', function() {
            calcularImporteLinea(nuevaLinea);
        });
        
        precioUnitarioInput.addEventListener('input', function() {
            calcularPrecioFinal(nuevaLinea);
        });
        
        descuentoInput.addEventListener('input', function() {
            calcularPrecioFinal(nuevaLinea);
        });
        
        precioFinalInput.addEventListener('input', function() {
            calcularImporteLinea(nuevaLinea);
        });
        
        // Botón eliminar
        nuevaLinea.querySelector('.btn-eliminar-linea').addEventListener('click', function() {
            if (lineasContainer.querySelectorAll('.linea-factura-row').length > 1) {
                nuevaLinea.remove();
                renumerarLineas();
                actualizarTotales();
            } else {
                alert('Debe haber al menos una línea en el albarán');
            }
        });
        
        lineasContainer.appendChild(nuevaLinea);
    });
    
    // Renumerar líneas
    function renumerarLineas() {
        document.querySelectorAll('.linea-factura-row').forEach((linea, index) => {
            linea.querySelector('.linea-factura-numero').textContent = '#' + (index + 1);
        });
    }
    
    // Event listeners para todas las líneas existentes
    document.querySelectorAll('.linea-cantidad, .precio-unitario, .descuento-input').forEach(input => {
        input.addEventListener('input', function() {
            const lineaRow = input.closest('.linea-factura-row');
            if (input.classList.contains('precio-unitario') || input.classList.contains('descuento-input')) {
                calcularPrecioFinal(lineaRow);
            } else {
                calcularImporteLinea(lineaRow);
            }
        });
    });
    
    // Event listeners para botones eliminar existentes
    document.querySelectorAll('.btn-eliminar-linea').forEach(btn => {
        btn.addEventListener('click', function() {
            if (lineasContainer.querySelectorAll('.linea-factura-row').length > 1) {
                btn.closest('.linea-factura-row').remove();
                renumerarLineas();
                actualizarTotales();
            } else {
                alert('Debe haber al menos una línea en el albarán');
            }
        });
    });
    
    // Cargar datos del cliente
    window.cargarDatosCliente = function() {
        const selectCliente = document.getElementById('cliente_id');
        const optionSeleccionada = selectCliente.options[selectCliente.selectedIndex];
        
        if (optionSeleccionada && optionSeleccionada.value) {
            const nombre = optionSeleccionada.getAttribute('data-nombre') || '';
            const nif = optionSeleccionada.getAttribute('data-nif') || '';
            const direccion = optionSeleccionada.getAttribute('data-direccion') || '';
            const poblacion = optionSeleccionada.getAttribute('data-poblacion') || '';
            const provincia = optionSeleccionada.getAttribute('data-provincia') || '';
            const codigoPostal = optionSeleccionada.getAttribute('data-codigo-postal') || '';
            const telefono = optionSeleccionada.getAttribute('data-telefono') || '';
            const email = optionSeleccionada.getAttribute('data-email') || '';
            
            document.getElementById('nombre_cliente').value = nombre;
            document.getElementById('nif_cliente').value = nif;
            document.getElementById('direccion_cliente').value = direccion;
            document.getElementById('poblacion_cliente').value = poblacion;
            document.getElementById('provincia_cliente').value = provincia;
            document.getElementById('codigo_postal_cliente').value = codigoPostal;
            document.getElementById('telefono_cliente').value = telefono;
            document.getElementById('email_cliente').value = email;
        } else {
            // Limpiar campos si no hay cliente seleccionado
            document.getElementById('nombre_cliente').value = '';
            document.getElementById('nif_cliente').value = '';
            document.getElementById('direccion_cliente').value = '';
            document.getElementById('poblacion_cliente').value = '';
            document.getElementById('provincia_cliente').value = '';
            document.getElementById('codigo_postal_cliente').value = '';
            document.getElementById('telefono_cliente').value = '';
            document.getElementById('email_cliente').value = '';
        }
    };
    
    // Calcular totales iniciales
    actualizarTotales();
});
</script>

<style>
.linea-factura-header {
    display: flex;
    align-items: stretch;
    gap: 8px;
    margin-bottom: 8px;
    padding: 8px;
    background: #e9ecef;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.85rem;
    color: #495057;
}

.linea-factura-numero-header {
    font-weight: bold;
    min-width: 35px;
    width: 35px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

.linea-factura-campos-header {
    display: flex;
    gap: 8px;
    flex: 1;
    align-items: stretch;
}

.header-col {
    font-weight: 600;
    font-size: 0.85rem;
    color: #495057;
    box-sizing: border-box;
    padding: 6px 8px;
    display: flex;
    align-items: center;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background: transparent;
}

.linea-factura-row {
    display: flex;
    align-items: stretch;
    gap: 8px;
    margin-bottom: 8px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 6px;
}

.linea-factura-numero {
    font-weight: bold;
    color: #495057;
    min-width: 35px;
    width: 35px;
    font-size: 0.9rem;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

.linea-factura-campos {
    display: flex;
    gap: 8px;
    flex: 1;
    align-items: stretch;
}

.linea-campo-compact {
    padding: 6px 8px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 0.85rem;
    box-sizing: border-box;
}

.linea-factura-campos input[type="text"]:first-of-type {
    min-width: 500px;
}

.importe-linea {
    font-size: 0.9rem;
}

.btn-eliminar-linea:hover {
    background: #c82333 !important;
}

.form-group {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    margin-bottom: 3px;
    font-size: 0.85rem;
    font-weight: 500;
    color: #495057;
}

.form-control {
    padding: 6px 10px;
    font-size: 0.9rem;
}
</style>
{% endblock %}

