{% extends "base.html" %}

{% block title %}Ver Presupuesto #{{ presupuesto.id }} - Gesti√≥n de Pedidos{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="{{ url_for('presupuestos.listado_presupuestos') }}" class="btn btn-primary">‚Üê Volver a la lista</a>
    <a href="{{ url_for('presupuestos.editar_presupuesto', presupuesto_id=presupuesto.id) }}" class="btn btn-warning">Editar</a>
    <a href="{{ url_for('presupuestos.imprimir_presupuesto', presupuesto_id=presupuesto.id) }}" class="btn btn-secondary" target="_blank">üñ®Ô∏è Imprimir</a>
    <a href="{{ url_for('presupuestos.descargar_pdf_presupuesto', presupuesto_id=presupuesto.id) }}" class="btn btn-success">üìÑ Descargar PDF</a>
    {% if presupuesto.cliente and presupuesto.cliente.email %}
    <form method="POST" action="{{ url_for('presupuestos.enviar_presupuesto_email', presupuesto_id=presupuesto.id) }}" style="display: inline;" onsubmit="return confirm('¬øEnviar presupuesto por email a {{ presupuesto.cliente.email }}?')">
        <button type="submit" class="btn btn-info">üìß Enviar por Correo</button>
    </form>
    {% else %}
    <button class="btn btn-info" disabled title="El cliente no tiene email configurado">üìß Enviar por Correo</button>
    {% endif %}
</div>

<h2>Presupuesto #{{ presupuesto.id }}</h2>

<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
    <!-- Columna 1: Datos del Cliente -->
    <div>
        <div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px;">Datos del Cliente</h3>
            
            <p><strong>Nombre:</strong> {{ presupuesto.cliente.nombre if presupuesto.cliente else 'N/A' }}</p>
            
            {% if presupuesto.cliente.direccion %}
            <p><strong>Direcci√≥n:</strong> {{ presupuesto.cliente.direccion }}</p>
            {% endif %}
            
            {% if presupuesto.cliente.telefono %}
            <p><strong>Tel√©fono:</strong> {{ presupuesto.cliente.telefono }}</p>
            {% endif %}
            
            {% if presupuesto.cliente.email %}
            <p><strong>Email:</strong> {{ presupuesto.cliente.email }}</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Columna 2: Datos del Presupuesto -->
    <div>
        <div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px;">Datos del Presupuesto</h3>
            
            <p><strong>Estado:</strong> 
                <span class="badge badge-estado-{{ presupuesto.estado|lower|replace(' ', '-')|replace('√≥', 'o')|replace('√≠', 'i')|replace('√©', 'e')|replace('de', 'de') }}">{{ presupuesto.estado }}</span>
            </p>
            
            <p><strong>Tipo de Presupuesto:</strong> {{ presupuesto.tipo_pedido }}</p>
            
            <p><strong>Comercial:</strong> {{ presupuesto.comercial.nombre if presupuesto.comercial else 'N/A' }}</p>
            
            {% if presupuesto.forma_pago %}
            <p><strong>Forma de Pago:</strong> {{ presupuesto.forma_pago }}</p>
            {% endif %}
            
            {% if presupuesto.fecha_envio %}
            <p><strong>Fecha de Env√≠o:</strong> {{ presupuesto.fecha_envio.strftime('%d/%m/%Y') }}</p>
            {% endif %}
            
            {% if presupuesto.fecha_respuesta %}
            <p><strong>Fecha de Respuesta:</strong> {{ presupuesto.fecha_respuesta.strftime('%d/%m/%Y') }}</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Columna 3: Imagen del Dise√±o -->
    <div>
        {% if presupuesto.imagen_diseno %}
        <div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px;">Dise√±o</h3>
            <img src="{{ url_for('static', filename='uploads/' + presupuesto.imagen_diseno) }}" 
                 alt="Dise√±o del presupuesto" 
                 style="max-width: 100%; max-height: 400px; width: auto; height: auto; border: 1px solid #ddd; border-radius: 4px; object-fit: contain; display: block; margin: 0 auto;">
        </div>
        {% else %}
        <div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; display: flex; align-items: center; justify-content: center; min-height: 200px;">
            <p style="color: #999;">No hay imagen de dise√±o</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Secci√≥n para cambiar estados -->
<div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px;">Cambiar Estado del Presupuesto</h3>
    <p style="margin-bottom: 15px; color: #666;">Haz clic en el estado correspondiente para avanzar en el proceso. Se actualizar√° autom√°ticamente la fecha si no est√° establecida.</p>
    
    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
        <div style="display: flex; flex-direction: column; align-items: center;">
            <form method="POST" action="{{ url_for('presupuestos.cambiar_estado_presupuesto', presupuesto_id=presupuesto.id) }}" style="display: inline;">
                <input type="hidden" name="estado" value="Pendiente de enviar">
                <button type="submit" class="btn" style="background-color: {% if presupuesto.estado == 'Pendiente de enviar' %}#95a5a6{% else %}#bdc3c7{% endif %}; color: white;" 
                        onclick="return confirm('¬øMarcar como Pendiente de enviar?')">
                    Pendiente de enviar
                </button>
            </form>
            <p style="margin-top: 5px; font-size: 12px; color: #999; margin-bottom: 0;">-</p>
        </div>
        
        <div style="display: flex; flex-direction: column; align-items: center;">
            <form method="POST" action="{{ url_for('presupuestos.cambiar_estado_presupuesto', presupuesto_id=presupuesto.id) }}" style="display: inline;">
                <input type="hidden" name="estado" value="Dise√±o">
                <button type="submit" class="btn" style="background-color: {% if presupuesto.estado == 'Dise√±o' %}#9b59b6{% else %}#95a5a6{% endif %}; color: white;" 
                        onclick="return confirm('¬øMarcar como Dise√±o?')">
                    Dise√±o
                </button>
            </form>
            <p style="margin-top: 5px; font-size: 12px; color: #999; margin-bottom: 0;">-</p>
        </div>
        
        <div style="display: flex; flex-direction: column; align-items: center;">
            <form method="POST" action="{{ url_for('presupuestos.cambiar_estado_presupuesto', presupuesto_id=presupuesto.id) }}" style="display: inline;">
                <input type="hidden" name="estado" value="Enviado">
                <button type="submit" class="btn" style="background-color: {% if presupuesto.estado == 'Enviado' %}#3498db{% else %}#95a5a6{% endif %}; color: white;" 
                        onclick="return confirm('¬øMarcar como Enviado?')">
                    Enviado
                </button>
            </form>
            {% if presupuesto.fecha_envio %}
            <p style="margin-top: 5px; font-size: 12px; color: #666; margin-bottom: 0;">{{ presupuesto.fecha_envio.strftime('%d/%m/%Y') }}</p>
            {% else %}
            <p style="margin-top: 5px; font-size: 12px; color: #999; margin-bottom: 0;">-</p>
            {% endif %}
        </div>
        
        <div style="display: flex; flex-direction: column; align-items: center;">
            <form method="POST" action="{{ url_for('presupuestos.cambiar_estado_presupuesto', presupuesto_id=presupuesto.id) }}" style="display: inline;" onsubmit="return confirm('¬øMarcar como Aceptado? Esto crear√° autom√°ticamente un nuevo pedido.');">
                <input type="hidden" name="estado" value="Aceptado">
                <button type="submit" class="btn" style="background-color: {% if presupuesto.estado == 'Aceptado' %}#27ae60{% else %}#95a5a6{% endif %}; color: white;">
                    Aceptado
                </button>
            </form>
            {% if presupuesto.fecha_respuesta and presupuesto.estado == 'Aceptado' %}
            <p style="margin-top: 5px; font-size: 12px; color: #666; margin-bottom: 0;">{{ presupuesto.fecha_respuesta.strftime('%d/%m/%Y') }}</p>
            {% else %}
            <p style="margin-top: 5px; font-size: 12px; color: #999; margin-bottom: 0;">-</p>
            {% endif %}
        </div>
        
        <div style="display: flex; flex-direction: column; align-items: center;">
            <form method="POST" action="{{ url_for('presupuestos.cambiar_estado_presupuesto', presupuesto_id=presupuesto.id) }}" style="display: inline;">
                <input type="hidden" name="estado" value="Rechazado">
                <button type="submit" class="btn" style="background-color: {% if presupuesto.estado == 'Rechazado' %}#e74c3c{% else %}#95a5a6{% endif %}; color: white;" 
                        onclick="return confirm('¬øMarcar como Rechazado?')">
                    Rechazado
                </button>
            </form>
            {% if presupuesto.fecha_respuesta and presupuesto.estado == 'Rechazado' %}
            <p style="margin-top: 5px; font-size: 12px; color: #666; margin-bottom: 0;">{{ presupuesto.fecha_respuesta.strftime('%d/%m/%Y') }}</p>
            {% else %}
            <p style="margin-top: 5px; font-size: 12px; color: #999; margin-bottom: 0;">-</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Secci√≥n de Seguimiento -->
<div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px;">Seguimiento</h3>
    
    <form method="POST" action="{{ url_for('presupuestos.actualizar_seguimiento', presupuesto_id=presupuesto.id) }}">
        <div class="form-group">
            <label for="seguimiento">Actualizaciones y seguimiento del presupuesto:</label>
            <textarea name="seguimiento" id="seguimiento" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px;">{{ presupuesto.seguimiento or '' }}</textarea>
        </div>
        <button type="submit" class="btn btn-success">Actualizar Seguimiento</button>
    </form>
</div>

<div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px;">Prendas del Presupuesto</h3>
    
    {% if presupuesto.lineas %}
    <div style="display: flex; flex-direction: column; gap: 15px;">
        {% for linea in presupuesto.lineas %}
        <div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; background-color: #f8f9fa;">
            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <div><strong>Modelo:</strong> {{ linea.prenda.nombre if linea.prenda else 'N/A' }} 
                    {% if linea.prenda %}({{ linea.prenda.tipo }}){% endif %}</div>
                
                <div><strong>Nombre:</strong> {{ linea.nombre }}</div>
                
                <div><strong>Cantidad:</strong> {{ linea.cantidad }}</div>
                
                {% if linea.cargo %}<div><strong>Cargo:</strong> {{ linea.cargo }}</div>{% endif %}
                
                {% if linea.color %}<div><strong>Color:</strong> {{ linea.color }}</div>{% endif %}
                
                {% if linea.forma %}<div><strong>Forma:</strong> {{ linea.forma }}</div>{% endif %}
                
                {% if linea.tipo_manda %}<div><strong>Tipo de Manga:</strong> {{ linea.tipo_manda }}</div>{% endif %}
                
                {% if linea.sexo %}<div><strong>Sexo:</strong> {{ linea.sexo }}</div>{% endif %}
                
                {% if linea.talla %}<div><strong>Talla:</strong> {{ linea.talla }}</div>{% endif %}
                
                {% if linea.tejido %}<div><strong>Tejido:</strong> {{ linea.tejido }}</div>{% endif %}
                
                {% if linea.precio_unitario %}<div><strong>Precio Unitario:</strong> {{ "%.2f"|format(linea.precio_unitario) }} ‚Ç¨</div>{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No hay prendas registradas en este presupuesto.</p>
    {% endif %}
</div>

{% endblock %}

