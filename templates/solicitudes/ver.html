{% extends "base.html" %}

{% block title %}Ver Solicitud #{{ solicitud.id }} - Gesti√≥n de Pedidos{% endblock %}

{% block content %}
<style>
/* Estilos para el modal de im√°genes */
.modal-imagenes {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.9);
}

.modal-imagenes-content {
    position: relative;
    margin: auto;
    padding: 20px;
    width: 90%;
    max-width: 1200px;
    top: 50%;
    transform: translateY(-50%);
}

.modal-imagenes-header {
    color: white;
    text-align: center;
    margin-bottom: 30px;
}

.modal-imagenes-header h2 {
    margin: 0;
    font-size: 28px;
}

.cerrar-modal {
    position: absolute;
    top: 20px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1001;
}

.cerrar-modal:hover {
    color: #fff;
}

.galeria-imagenes {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.imagen-galeria-item {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.imagen-galeria-item img {
    width: 100%;
    height: auto;
    border-radius: 4px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: transform 0.3s;
}

.imagen-galeria-item img:hover {
    transform: scale(1.05);
}

.imagen-galeria-item p {
    margin: 0;
    color: #333;
    font-size: 14px;
    font-weight: 500;
}

.imagen-galeria-descripcion {
    color: #666;
    font-size: 12px;
    margin-top: 5px;
    font-style: italic;
}
</style>
<div style="margin-bottom: 20px;">
    <a href="{{ url_for('solicitudes.listado_solicitudes') }}" class="btn btn-primary">‚Üê Volver a la lista</a>
    <a href="{{ url_for('solicitudes.editar_solicitud', solicitud_id=solicitud.id) }}" class="btn btn-warning">Editar</a>
    <a href="{{ url_for('solicitudes.descargar_pdf_solicitud', solicitud_id=solicitud.id) }}" class="btn btn-success" target="_blank">üìÑ Descargar PDF</a>
</div>

<h2>Solicitud #{{ solicitud.id }}</h2>

<!-- Esquema horizontal de estados y subestados -->
<div style="margin-bottom: 30px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px;">Seguimiento de Estados</h3>
    <div style="overflow-x: auto; padding: 10px 0;">
        <div style="display: flex; gap: 15px; min-width: max-content; align-items: flex-start;">
            {% set estados_completos = [
                {'estado': 'presupuesto', 'subestados': []},
                {'estado': 'aceptado', 'subestados': []},
                {'estado': 'mockup', 'subestados': ['enviado a cliente', 'prueba 1', 'prueba 2', 'aceptado']},
                {'estado': 'en preparacion', 'subestados': ['hacer marcada', 'imprimir', 'calandra', 'corte', 'confeccion', 'sublimacion', 'bordado']},
                {'estado': 'terminado', 'subestados': []},
                {'estado': 'entregado al cliente', 'subestados': []}
            ] %}
            
            {% for estado_info in estados_completos %}
            {% set estado_actual = estado_info.estado %}
            {% set fecha_campo = estados_fechas.get(estado_actual, '') %}
            {% set fecha_estado = None %}
            {% if fecha_campo %}
                {% if fecha_campo == 'fecha_presupuesto' %}
                    {% set fecha_estado = solicitud.fecha_presupuesto %}
                {% elif fecha_campo == 'fecha_aceptado' %}
                    {% set fecha_estado = solicitud.fecha_aceptado %}
                {% elif fecha_campo == 'fecha_mockup' %}
                    {% set fecha_estado = solicitud.fecha_mockup %}
                {% elif fecha_campo == 'fecha_en_preparacion' %}
                    {% set fecha_estado = solicitud.fecha_en_preparacion %}
                {% elif fecha_campo == 'fecha_terminado' %}
                    {% set fecha_estado = solicitud.fecha_terminado %}
                {% elif fecha_campo == 'fecha_entregado_cliente' %}
                    {% set fecha_estado = solicitud.fecha_entregado_cliente %}
                {% endif %}
            {% endif %}
            {% set registros_estado_actual = registros_estado|selectattr('estado', 'equalto', estado_actual)|list %}
            {% set esta_activo = solicitud.estado == estado_actual %}
            
            <div style="display: flex; flex-direction: column; align-items: center; min-width: 150px;">
                <!-- Estado principal -->
                {% set registro_estado_principal = registros_estado_actual[0] if registros_estado_actual|length > 0 else None %}
                {% set usuario_estado = registro_estado_principal.usuario.usuario if registro_estado_principal and registro_estado_principal.usuario else 'Sistema' %}
                {% set fecha_hora_estado = registro_estado_principal.fecha_cambio if registro_estado_principal else (fecha_estado if fecha_estado else None) %}
                <div style="padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; text-align: center; cursor: help;
                            {% if esta_activo %}background: #007bff; color: white; font-weight: bold;{% else %}background: #f8f9fa; color: #6c757d;{% endif %}
                            border: 2px solid {% if esta_activo %}#007bff{% else %}#dee2e6{% endif %};"
                     title="{% if fecha_hora_estado %}Fecha: {{ fecha_hora_estado.strftime('%d/%m/%Y %H:%M') if fecha_hora_estado.__class__.__name__ == 'datetime' else fecha_hora_estado.strftime('%d/%m/%Y') }}{% endif %}{% if usuario_estado %} | Usuario: {{ usuario_estado }}{% endif %}">
                    <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 5px;">{{ estado_actual|title }}</div>
                    {% if fecha_estado %}
                    <div style="font-size: 0.75rem; opacity: 0.9;">{{ fecha_estado.strftime('%d/%m/%Y') }}</div>
                    {% elif registros_estado_actual|length > 0 %}
                    <div style="font-size: 0.75rem; opacity: 0.9;">{{ registros_estado_actual[0].fecha_cambio.strftime('%d/%m/%Y') }}</div>
                    {% else %}
                    <div style="font-size: 0.75rem; opacity: 0.7;">-</div>
                    {% endif %}
                </div>
                
                <!-- Subestados -->
                {% if estado_info.subestados|length > 0 %}
                <div style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
                    {% for subestado in estado_info.subestados %}
                    {% set registros_subestado = registros_estado|selectattr('estado', 'equalto', estado_actual)|selectattr('subestado', 'equalto', subestado)|list %}
                    {% set subestado_activo = esta_activo and solicitud.subestado == subestado %}
                    {% set registro_subestado = registros_subestado[0] if registros_subestado|length > 0 else None %}
                    {% set fecha_subestado = registro_subestado.fecha_cambio if registro_subestado else None %}
                    {% set usuario_subestado = registro_subestado.usuario.usuario if registro_subestado and registro_subestado.usuario else 'Sistema' %}
                    
                    <div style="padding: 8px 12px; border-radius: 6px; text-align: center; font-size: 0.8rem; cursor: help;
                                {% if subestado_activo %}background: #28a745; color: white; font-weight: bold;{% elif fecha_subestado %}background: #e9ecef; color: #495057;{% else %}background: #f8f9fa; color: #adb5bd;{% endif %}
                                border: 1px solid {% if subestado_activo %}#28a745{% elif fecha_subestado %}#dee2e6{% else %}#e9ecef{% endif %};"
                         title="{% if fecha_subestado %}Fecha: {{ fecha_subestado.strftime('%d/%m/%Y %H:%M') if fecha_subestado.__class__.__name__ == 'datetime' else fecha_subestado.strftime('%d/%m/%Y') }}{% endif %}{% if usuario_subestado %} | Usuario: {{ usuario_subestado }}{% endif %}">
                        <div style="margin-bottom: 3px;">{{ subestado|title }}</div>
                        {% if fecha_subestado %}
                        <div style="font-size: 0.7rem; opacity: 0.8;">{{ fecha_subestado.strftime('%d/%m/%Y') }}</div>
                        {% else %}
                        <div style="font-size: 0.7rem; opacity: 0.5;">-</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <!-- Flecha conectora (excepto en el √∫ltimo) -->
            {% if not loop.last %}
            <div style="display: flex; align-items: center; padding: 0 5px; color: #6c757d; font-size: 1.5rem;">‚Üí</div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    
    <!-- Informaci√≥n adicional de mockup -->
    {% if solicitud.estado == 'mockup' and solicitud.fecha_limite_mockup and hoy is defined %}
    <div style="margin-top: 15px; padding: 10px; background: {% if hoy > solicitud.fecha_limite_mockup %}#dc3545{% elif (solicitud.fecha_limite_mockup - hoy).days <= 1 %}#ffc107{% else %}#28a745{% endif %}; color: white; border-radius: 6px; text-align: center;">
        <strong>Fecha l√≠mite Mockup:</strong> {{ solicitud.fecha_limite_mockup.strftime('%d/%m/%Y') }}
        {% set dias_restantes = (solicitud.fecha_limite_mockup - hoy).days %}
        {% if dias_restantes < 0 %}
        <span style="margin-left: 10px;">(Vencido hace {{ -dias_restantes }} d√≠a{{ 's' if -dias_restantes != 1 else '' }})</span>
        {% elif dias_restantes == 0 %}
        <span style="margin-left: 10px;">(Vence hoy)</span>
        {% else %}
        <span style="margin-left: 10px;">({{ dias_restantes }} d√≠a{{ 's' if dias_restantes != 1 else '' }} restante{{ 's' if dias_restantes != 1 else '' }})</span>
        {% endif %}
    </div>
    {% endif %}
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
    <!-- Columna 1: Datos del Cliente -->
    <div>
        <div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px;">Datos del Cliente</h3>
            
            <p><strong>Nombre:</strong> {{ solicitud.cliente.nombre if solicitud.cliente else 'N/A' }}</p>
            
            {% if solicitud.cliente.direccion %}
            <p><strong>Direcci√≥n:</strong> {{ solicitud.cliente.direccion }}</p>
            {% endif %}
            
            {% if solicitud.cliente.telefono %}
            <p><strong>Tel√©fono:</strong> {{ solicitud.cliente.telefono }}</p>
            {% endif %}
            
            {% if solicitud.cliente.email %}
            <p><strong>Email:</strong> {{ solicitud.cliente.email }}</p>
            {% endif %}
        </div>
        
        <!-- Secci√≥n de Seguimiento -->
        <div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px;">Seguimiento</h3>
            
            <form method="POST" action="{{ url_for('solicitudes.actualizar_seguimiento', solicitud_id=solicitud.id) }}">
                <div class="form-group">
                    <label for="seguimiento" style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Actualizaciones y seguimiento:</label>
                    <textarea name="seguimiento" id="seguimiento" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px; box-sizing: border-box;">{{ solicitud.seguimiento or '' }}</textarea>
                </div>
                <button type="submit" class="btn btn-success" style="padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Actualizar Seguimiento</button>
            </form>
        </div>
    </div>
    
    <!-- Columna 2: Datos de la Solicitud -->
    <div>
        <div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px;">Datos de la Solicitud</h3>
            
            <p><strong>Estado Actual:</strong> 
                <span class="badge badge-estado-{{ solicitud.estado|lower|replace(' ', '-') }}" style="padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; display: inline-block;">
                    {{ solicitud.estado|title }}
                </span>
            </p>
            
            <p><strong>Tipo:</strong> {{ solicitud.tipo_pedido|title }}</p>
            
            <p><strong>Comercial:</strong> {{ solicitud.comercial.nombre if solicitud.comercial else 'N/A' }}</p>
            
            {% if solicitud.fecha_creacion %}
            <p><strong>Fecha de Creaci√≥n:</strong> {{ solicitud.fecha_creacion.strftime('%d/%m/%Y') }}</p>
            {% endif %}
            
            {% if solicitud.forma_pago %}
            <p><strong>Forma de Pago:</strong> {{ solicitud.forma_pago }}</p>
            {% endif %}
            
            {% if solicitud.fecha_objetivo %}
            <p><strong>Fecha Objetivo:</strong> 
                <span style="font-weight: bold; color: #007bff;">{{ solicitud.fecha_objetivo.strftime('%d/%m/%Y') }}</span>
            </p>
            {% endif %}
            
            <!-- Secci√≥n para cambiar estados -->
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 14px;">Cambiar Estado</h4>
                <p style="margin-bottom: 10px; color: #666; font-size: 12px;">Selecciona el nuevo estado de la solicitud:</p>
                
                <form method="POST" action="{{ url_for('solicitudes.cambiar_estado_solicitud', solicitud_id=solicitud.id) }}" id="form_cambiar_estado">
                    <select name="estado" id="estado_select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-bottom: 10px;" onchange="actualizarSubestados()">
                        {% for estado in estados %}
                        <option value="{{ estado }}" {% if solicitud.estado == estado %}selected{% endif %}>{{ estado|title }}</option>
                        {% endfor %}
                    </select>
                    
                    <div id="subestado_container" style="margin-bottom: 10px; display: none;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">Subestado:</label>
                        <select name="subestado" id="subestado_select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">-- Sin subestado --</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Cambiar Estado</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Columna 3: Im√°genes -->
    <div>
        <div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px;">Im√°genes</h3>
            
            {% if solicitud.imagen_diseno %}
            <div style="margin-bottom: 15px;">
                <p style="font-weight: 600; margin-bottom: 10px; color: #555;">Imagen de Dise√±o:</p>
                <img src="{{ url_for('solicitudes.servir_imagen_sftp', ruta_imagen=solicitud.imagen_diseno) }}" 
                     alt="Imagen de dise√±o" 
                     style="width: 100%; max-width: 300px; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;"
                     onclick="abrirModalImagenes()">
            </div>
            {% else %}
            <p style="color: #999; font-style: italic; margin-bottom: 15px;">No hay imagen de dise√±o</p>
            {% endif %}
            
            {% set tiene_imagenes_adicionales = solicitud.imagen_portada or solicitud.imagen_adicional_1 or solicitud.imagen_adicional_2 or solicitud.imagen_adicional_3 or solicitud.imagen_adicional_4 or solicitud.imagen_adicional_5 %}
            {% if tiene_imagenes_adicionales %}
            <div>
                <a href="#" onclick="abrirModalImagenes(); return false;" 
                   style="display: inline-block; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; font-weight: 500; transition: background-color 0.3s;">
                    üì∑ Ver todas las im√°genes
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
</div>

<!-- L√≠neas de la Solicitud - Ocupando todo el ancho -->
<div style="margin-top: 30px; width: 100%;">
    <div class="card" style="background-color: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px;">L√≠neas de la Solicitud</h3>
        
        <!-- DEBUG: Verificando l√≠neas - solicitud.lineas existe: {{ solicitud.lineas is defined }}, longitud: {{ solicitud.lineas|length if solicitud.lineas else 0 }} -->
        {% if solicitud.lineas and solicitud.lineas|length > 0 %}
        <div style="display: flex; flex-direction: column; gap: 15px;">
            {% for linea in solicitud.lineas %}
            <!-- DEBUG L√≠nea {{ loop.index }}: ID={{ linea.id }}, nombre_mostrar={{ linea.nombre_mostrar }}, prenda_id={{ linea.prenda_id }} -->
            <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px;">
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Nombre para mostrar:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.nombre_mostrar or linea.nombre or 'N/A' }}</p>
                    </div>
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Prenda:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.prenda.nombre if linea.prenda else 'N/A' }}</p>
                    </div>
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Cantidad:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.cantidad }}</p>
                    </div>
                    {% if linea.color %}
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Color:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.color }}</p>
                    </div>
                    {% endif %}
                    {% if linea.forma %}
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Forma:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.forma }}</p>
                    </div>
                    {% endif %}
                    {% if linea.sexo %}
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Sexo:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.sexo|title }}</p>
                    </div>
                    {% endif %}
                    {% if linea.talla %}
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Talla:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.talla }}</p>
                    </div>
                    {% endif %}
                    {% if linea.tejido %}
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Tejido:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.tejido }}</p>
                    </div>
                    {% endif %}
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Precio Unitario:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ "%.2f"|format(linea.precio_unitario) if linea.precio_unitario else '0.00' }} ‚Ç¨</p>
                    </div>
                    {% if linea.descuento and linea.descuento > 0 %}
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Descuento:</strong>
                        <p style="margin: 5px 0 0 0; color: #d32f2f;">{{ "%.0f"|format(linea.descuento) }}%</p>
                    </div>
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Precio Final:</strong>
                        <p style="margin: 5px 0 0 0; color: #d32f2f; font-weight: bold;">{{ "%.2f"|format(linea.precio_final) if linea.precio_final else '0.00' }} ‚Ç¨</p>
                    </div>
                    {% endif %}
                    {% if linea.nombre %}
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Nombre personalizado:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.nombre }}</p>
                    </div>
                    {% endif %}
                    {% if linea.cargo %}
                    <div>
                        <strong style="color: #495057; font-size: 0.85rem;">Cargo:</strong>
                        <p style="margin: 5px 0 0 0; color: #212529;">{{ linea.cargo }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: #6c757d;">No hay l√≠neas en esta solicitud.</p>
        {% endif %}
    </div>
</div>

<style>
.badge-estado-presupuesto { background: #6c757d; color: white; }
.badge-estado-aceptado { background: #28a745; color: white; }
.badge-estado-dise√±o { background: #17a2b8; color: white; }
.badge-estado-dise√±o-finalizado { background: #138496; color: white; }
.badge-estado-en-preparacion { background: #ffc107; color: #212529; }
.badge-estado-todo-listo { background: #fd7e14; color: white; }
.badge-estado-enviado { background: #007bff; color: white; }
.badge-estado-entregado-al-cliente { background: #28a745; color: white; }
.badge-estado-pedido-rechazado { background: #dc3545; color: white; }

.badge-estado-linea-pendiente { background: #6c757d; color: white; }
.badge-estado-linea-en-confecci√≥n { background: #17a2b8; color: white; }
.badge-estado-linea-en-bordado { background: #ffc107; color: #212529; }
.badge-estado-linea-listo { background: #28a745; color: white; }

/* Estilos para las l√≠neas */
.linea-solicitud-card {
    transition: all 0.3s ease;
}

.linea-solicitud-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

select[name="estado"] {
    transition: all 0.3s ease;
}

select[name="estado"]:hover {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

select[name="estado"]:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
}
</style>

<!-- Modal de Im√°genes -->
<div id="modalImagenes" class="modal-imagenes">
    <span class="cerrar-modal" onclick="cerrarModalImagenes()">&times;</span>
    <div class="modal-imagenes-content">
        <div class="modal-imagenes-header">
            <h2>Galer√≠a de Im√°genes - Solicitud #{{ solicitud.id }}</h2>
        </div>
        <div class="galeria-imagenes">
            {% if solicitud.imagen_diseno %}
            <div class="imagen-galeria-item">
                <img src="{{ url_for('solicitudes.servir_imagen_sftp', ruta_imagen=solicitud.imagen_diseno) }}" alt="Imagen de dise√±o">
                <p>Imagen de Dise√±o</p>
            </div>
            {% endif %}
            
            {% if solicitud.imagen_portada %}
            <div class="imagen-galeria-item">
                <img src="{{ url_for('solicitudes.servir_imagen_sftp', ruta_imagen=solicitud.imagen_portada) }}" alt="Imagen de portada">
                <p>Imagen de Portada</p>
            </div>
            {% endif %}
            
            {% if solicitud.imagen_adicional_1 %}
            <div class="imagen-galeria-item">
                <img src="{{ url_for('solicitudes.servir_imagen_sftp', ruta_imagen=solicitud.imagen_adicional_1) }}" alt="Imagen adicional 1">
                <p>Imagen Adicional 1</p>
                {% if solicitud.descripcion_imagen_1 %}
                <div class="imagen-galeria-descripcion">{{ solicitud.descripcion_imagen_1 }}</div>
                {% endif %}
            </div>
            {% endif %}
            
            {% if solicitud.imagen_adicional_2 %}
            <div class="imagen-galeria-item">
                <img src="{{ url_for('solicitudes.servir_imagen_sftp', ruta_imagen=solicitud.imagen_adicional_2) }}" alt="Imagen adicional 2">
                <p>Imagen Adicional 2</p>
                {% if solicitud.descripcion_imagen_2 %}
                <div class="imagen-galeria-descripcion">{{ solicitud.descripcion_imagen_2 }}</div>
                {% endif %}
            </div>
            {% endif %}
            
            {% if solicitud.imagen_adicional_3 %}
            <div class="imagen-galeria-item">
                <img src="{{ url_for('solicitudes.servir_imagen_sftp', ruta_imagen=solicitud.imagen_adicional_3) }}" alt="Imagen adicional 3">
                <p>Imagen Adicional 3</p>
                {% if solicitud.descripcion_imagen_3 %}
                <div class="imagen-galeria-descripcion">{{ solicitud.descripcion_imagen_3 }}</div>
                {% endif %}
            </div>
            {% endif %}
            
            {% if solicitud.imagen_adicional_4 %}
            <div class="imagen-galeria-item">
                <img src="{{ url_for('solicitudes.servir_imagen_sftp', ruta_imagen=solicitud.imagen_adicional_4) }}" alt="Imagen adicional 4">
                <p>Imagen Adicional 4</p>
                {% if solicitud.descripcion_imagen_4 %}
                <div class="imagen-galeria-descripcion">{{ solicitud.descripcion_imagen_4 }}</div>
                {% endif %}
            </div>
            {% endif %}
            
            {% if solicitud.imagen_adicional_5 %}
            <div class="imagen-galeria-item">
                <img src="{{ url_for('solicitudes.servir_imagen_sftp', ruta_imagen=solicitud.imagen_adicional_5) }}" alt="Imagen adicional 5">
                <p>Imagen Adicional 5</p>
                {% if solicitud.descripcion_imagen_5 %}
                <div class="imagen-galeria-descripcion">{{ solicitud.descripcion_imagen_5 }}</div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function abrirModalImagenes() {
    document.getElementById('modalImagenes').style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevenir scroll del body
}

function cerrarModalImagenes() {
    document.getElementById('modalImagenes').style.display = 'none';
    document.body.style.overflow = 'auto'; // Restaurar scroll del body
}

// Cerrar modal al hacer clic fuera del contenido
window.onclick = function(event) {
    const modal = document.getElementById('modalImagenes');
    if (event.target == modal) {
        cerrarModalImagenes();
    }
}

// Cerrar modal con tecla ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        cerrarModalImagenes();
    }
});

// Funci√≥n para actualizar subestados seg√∫n el estado seleccionado
function actualizarSubestados() {
    const estadoSelect = document.getElementById('estado_select');
    const subestadoContainer = document.getElementById('subestado_container');
    const subestadoSelect = document.getElementById('subestado_select');
    const estadoSeleccionado = estadoSelect.value;
    
    // Limpiar opciones anteriores
    subestadoSelect.innerHTML = '<option value="">-- Sin subestado --</option>';
    
    // Definir subestados por estado
    const subestados = {
        'mockup': ['enviado a cliente', 'prueba 1', 'prueba 2', 'aceptado'],
        'en preparacion': ['hacer marcada', 'imprimir', 'calandra', 'corte', 'confeccion', 'sublimacion', 'bordado']
    };
    
    if (subestados[estadoSeleccionado]) {
        subestadoContainer.style.display = 'block';
        subestados[estadoSeleccionado].forEach(function(subestado) {
            const option = document.createElement('option');
            option.value = subestado;
            option.textContent = subestado.charAt(0).toUpperCase() + subestado.slice(1);
            {% if solicitud.subestado %}
            if (subestado === '{{ solicitud.subestado }}') {
                option.selected = true;
            }
            {% endif %}
            subestadoSelect.appendChild(option);
        });
    } else {
        subestadoContainer.style.display = 'none';
    }
}

// Ejecutar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    actualizarSubestados();
});
</script>
{% endblock %}

