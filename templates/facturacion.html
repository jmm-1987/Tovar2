{% extends "base.html" %}

{% block title %}Facturaci√≥n - Gesti√≥n de Pedidos{% endblock %}

{% block content %}
<style>
.container {
    padding-top: 10px !important;
    padding-left: 5px !important;
    padding-right: 5px !important;
    max-width: 100% !important;
}
header {
    margin-bottom: 0.8rem !important;
}
h2::after {
    display: none;
}
</style>
<h2 style="margin: 0 0 8px 0; padding-bottom: 0; font-size: 1.3rem;">Facturaci√≥n</h2>

<!-- FILTROS -->
<div style="margin-bottom: 15px;">
    <div class="filtros-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #e9ecef;">
        <form method="GET" action="{{ url_for('facturacion.facturacion') }}" id="filtros-form" style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
            <!-- Mantener otros filtros al cambiar tipo -->
            {% if estado_filtro %}<input type="hidden" name="estado" value="{{ estado_filtro }}">{% endif %}
            {% if fecha_desde %}<input type="hidden" name="fecha_desde" value="{{ fecha_desde }}">{% endif %}
            {% if fecha_hasta %}<input type="hidden" name="fecha_hasta" value="{{ fecha_hasta }}">{% endif %}
            
            <div class="filtro-group" style="display: flex; flex-direction: column; gap: 6px; min-width: 200px;">
                <label style="font-size: 0.75rem; font-weight: 600; color: #495057; display: flex; align-items: center; gap: 4px;">
                    <span>üìã</span> Tipo
                </label>
                <div style="display: flex; gap: 0; border: 2px solid #dee2e6; border-radius: 6px; overflow: hidden; background: white;">
                    <button type="button" class="tipo-selector-btn {% if tipo_vista == 'pendientes' %}active{% endif %}" 
                            onclick="cambiarTipoVista('pendientes')"
                            style="flex: 1; padding: 6px 12px; border: none; background: {% if tipo_vista == 'pendientes' %}#007bff{% else %}#ffffff{% endif %}; color: {% if tipo_vista == 'pendientes' %}#ffffff{% else %}#495057{% endif %}; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        Pendientes
                    </button>
                    <button type="button" class="tipo-selector-btn {% if tipo_vista == 'formalizadas' %}active{% endif %}" 
                            onclick="cambiarTipoVista('formalizadas')"
                            style="flex: 1; padding: 6px 12px; border: none; border-left: 2px solid #dee2e6; background: {% if tipo_vista == 'formalizadas' %}#007bff{% else %}#ffffff{% endif %}; color: {% if tipo_vista == 'formalizadas' %}#ffffff{% else %}#495057{% endif %}; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        Formalizadas
                    </button>
                </div>
                <input type="hidden" name="tipo_vista" id="tipo_vista_input" value="{{ tipo_vista }}">
            </div>
            
            <div class="filtro-group" style="display: flex; flex-direction: column; flex: 1; min-width: 150px;">
                <label for="estado" style="font-size: 0.75rem; font-weight: 600; color: #495057; margin-bottom: 3px; display: flex; align-items: center; gap: 4px;">
                    <span>üè∑Ô∏è</span> Estado
                </label>
                <select name="estado" id="estado" class="filtro-input" style="padding: 6px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.85rem; background: white; color: #495057; transition: all 0.3s ease; cursor: pointer;">
                    <option value="">Todos los estados</option>
                    {% for estado in estados %}
                    <option value="{{ estado }}" {% if estado_filtro == estado %}selected{% endif %}>{{ estado }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filtro-group" style="display: flex; flex-direction: column; flex: 1; min-width: 150px;">
                <label for="fecha_desde" style="font-size: 0.75rem; font-weight: 600; color: #495057; margin-bottom: 3px; display: flex; align-items: center; gap: 4px;">
                    <span>üìÖ</span> Fecha Desde
                </label>
                <input type="date" name="fecha_desde" id="fecha_desde" value="{{ fecha_desde }}" class="filtro-input" style="padding: 6px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.85rem; background: white; color: #495057; transition: all 0.3s ease;">
            </div>
            
            <div class="filtro-group" style="display: flex; flex-direction: column; flex: 1; min-width: 150px;">
                <label for="fecha_hasta" style="font-size: 0.75rem; font-weight: 600; color: #495057; margin-bottom: 3px; display: flex; align-items: center; gap: 4px;">
                    <span>üìÖ</span> Fecha Hasta
                </label>
                <input type="date" name="fecha_hasta" id="fecha_hasta" value="{{ fecha_hasta }}" class="filtro-input" style="padding: 6px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.85rem; background: white; color: #495057; transition: all 0.3s ease;">
            </div>
            
            <div style="display: flex; gap: 8px; align-items: flex-end;">
                <button type="submit" class="btn btn-primary" style="padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,123,255,0.3); transition: all 0.3s ease;">
                    üîç Filtrar
                </button>
                {% if tipo_vista != 'pendientes' or estado_filtro or fecha_desde or fecha_hasta %}
                <a href="{{ url_for('facturacion.facturacion') }}" class="btn btn-secondary" style="padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; transition: all 0.3s ease;">
                    üóëÔ∏è Limpiar
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<script>
function cambiarTipoVista(tipo) {
    document.getElementById('tipo_vista_input').value = tipo;
    document.getElementById('filtros-form').submit();
}
</script>

<!-- BOTONES PARA CREAR FACTURA DIRECTA Y NUEVO ALBAR√ÅN -->
<div style="margin-bottom: 20px; text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
    <a href="{{ url_for('facturacion.nueva_factura') }}" class="btn btn-success" style="padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; display: inline-block; box-shadow: 0 2px 4px rgba(40,167,69,0.3); transition: all 0.3s ease;">
        ‚ûï Crear Factura Directa
    </a>
    <a href="{{ url_for('facturacion.nuevo_albaran') }}" class="btn btn-primary" style="padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; display: inline-block; box-shadow: 0 2px 4px rgba(0,123,255,0.3); transition: all 0.3s ease;">
        üìÑ Nuevo Albar√°n
    </a>
    <a href="{{ url_for('facturacion.facturar_albaranes') }}" class="btn btn-warning" style="padding: 10px 20px; background: #ffc107; color: #212529; text-decoration: none; border-radius: 6px; font-weight: 600; display: inline-block; box-shadow: 0 2px 4px rgba(255,193,7,0.3); transition: all 0.3s ease;">
        üßæ Facturar Albaranes
    </a>
</div>

<!-- SECCI√ìN DE PREFACTURAS (Pendientes de formalizar) -->
{% if tipo_vista == 'pendientes' %}

{% if prefacturas %}
<div class="table-container" style="background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 40px;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); border-bottom: 2px solid #1a252f;">
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">ID</th>
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">Cliente</th>
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">Tipo</th>
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">Estado</th>
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">Fecha Aceptaci√≥n</th>
                <th style="padding: 15px; text-align: center; color: #ffffff; font-weight: 600;">L√≠neas</th>
                <th style="padding: 15px; text-align: center; color: #ffffff; font-weight: 600;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for prefactura in prefacturas %}
            {% set es_solicitud = prefactura.__class__.__name__ == 'Presupuesto' %}
            {% set es_albaran = prefactura.__class__.__name__ == 'Factura' and prefactura.numero.startswith('A') and '_' in prefactura.numero %}
            <tr class="pedido-row" style="border-bottom: 1px solid #e9ecef; transition: all 0.3s ease;">
                <td style="padding: 15px; color: #212529; font-weight: 600;">#{{ prefactura.id }}</td>
                <td style="padding: 15px; color: #212529; font-weight: 500;">
                    {% if es_albaran %}
                        {{ prefactura.nombre if prefactura.nombre else 'N/A' }}
                    {% else %}
                        {{ prefactura.cliente.nombre if prefactura.cliente else 'N/A' }}
                    {% endif %}
                </td>
                <td style="padding: 15px; color: #212529;">
                    {% if es_solicitud %}
                        Solicitud - {{ prefactura.tipo_pedido if prefactura.tipo_pedido else 'N/A' }}
                    {% elif es_albaran %}
                        Albar√°n - {{ prefactura.numero }}
                    {% else %}
                        {{ prefactura.tipo_pedido }}
                    {% endif %}
                </td>
                <td style="padding: 15px;">
                    <span class="badge badge-estado-{{ prefactura.estado.lower()|replace(' ', '-')|replace('√≥', 'o')|replace('√≠', 'i')|replace('√©', 'e') }}">
                        {{ prefactura.estado }}
                    </span>
                </td>
                <td style="padding: 15px; color: #212529;">
                    {% if es_solicitud %}
                        {% if prefactura.fecha_aceptado %}
                            {{ prefactura.fecha_aceptado.strftime('%d/%m/%Y') }}
                        {% else %}
                            <span style="color: #999;">-</span>
                        {% endif %}
                    {% elif es_albaran %}
                        {% if prefactura.fecha_expedicion %}
                            {{ prefactura.fecha_expedicion.strftime('%d/%m/%Y') }}
                        {% else %}
                            <span style="color: #999;">-</span>
                        {% endif %}
                    {% else %}
                        {% if prefactura.fecha_aceptacion %}
                            {{ prefactura.fecha_aceptacion.strftime('%d/%m/%Y') }}
                        {% else %}
                            <span style="color: #999;">-</span>
                        {% endif %}
                    {% endif %}
                </td>
                <td style="padding: 15px; text-align: center; color: #212529;">
                    {{ prefactura.lineas|length }} l√≠nea{{ 's' if prefactura.lineas|length != 1 else '' }}
                </td>
                <td style="padding: 15px; text-align: center;">
                    {% if es_solicitud %}
                        <a href="{{ url_for('facturacion.ver_factura_solicitud', presupuesto_id=prefactura.id) }}" 
                           class="btn btn-info" 
                           style="padding: 8px 15px; font-size: 0.9rem; text-decoration: none; display: inline-block; margin-right: 5px;">
                            Hacer Factura
                        </a>
                        <a href="{{ url_for('solicitudes.descargar_albaran_solicitud', solicitud_id=prefactura.id) }}" 
                           class="btn btn-secondary" 
                           style="padding: 8px 15px; font-size: 0.9rem; text-decoration: none; display: inline-block;"
                           target="_blank">
                            üìã Albar√°n
                        </a>
                    {% elif es_albaran %}
                        <a href="{{ url_for('facturacion.editar_albaran', factura_id=prefactura.id) }}" 
                           class="btn btn-info" 
                           style="padding: 8px 15px; font-size: 0.9rem; text-decoration: none; display: inline-block; margin-right: 5px;">
                            ‚úèÔ∏è Editar
                        </a>
                        <a href="{{ url_for('facturacion.descargar_pdf_factura', factura_id=prefactura.id) }}" 
                           class="btn btn-secondary" 
                           style="padding: 8px 15px; font-size: 0.9rem; text-decoration: none; display: inline-block;"
                           target="_blank">
                            üìÑ PDF
                        </a>
                    {% else %}
                        <a href="{{ url_for('facturacion.ver_factura', pedido_id=prefactura.id) }}" 
                           class="btn btn-info" 
                           style="padding: 8px 15px; font-size: 0.9rem; text-decoration: none; display: inline-block; margin-right: 5px;">
                            Hacer Factura
                        </a>
                        <a href="{{ url_for('facturacion.descargar_pdf_albaran_pedido', pedido_id=prefactura.id) }}" 
                           class="btn btn-secondary" 
                           style="padding: 8px 15px; font-size: 0.9rem; text-decoration: none; display: inline-block;"
                           target="_blank">
                            üìã Albar√°n
                        </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div style="background: white; border-radius: 8px; padding: 40px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 40px;">
    <p style="color: #999; font-size: 1.1rem; margin: 0;">No hay prefacturas pendientes.</p>
</div>
{% endif %}

<!-- SECCI√ìN DE FACTURAS (Ya formalizadas) -->
{% else %}

{% if facturas %}
<div class="table-container" style="background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); border-bottom: 2px solid #1e8449;">
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">Serie-N¬∫</th>
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">Cliente</th>
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">Fecha Expedici√≥n</th>
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">Importe Total</th>
                <th style="padding: 15px; text-align: left; color: #ffffff; font-weight: 600;">Estado</th>
                <th style="padding: 15px; text-align: center; color: #ffffff; font-weight: 600;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for factura in facturas %}
            <tr class="factura-row" style="border-bottom: 1px solid #e9ecef; transition: all 0.3s ease;">
                <td style="padding: 15px; color: #212529; font-weight: 600;">{{ factura.serie }}-{{ factura.numero }}</td>
                <td style="padding: 15px; color: #212529; font-weight: 500;">
                    {{ factura.nombre }}
                </td>
                <td style="padding: 15px; color: #212529;">
                    {% if factura.fecha_expedicion %}
                        {{ factura.fecha_expedicion.strftime('%d/%m/%Y') }}
                    {% else %}
                        <span style="color: #999;">-</span>
                    {% endif %}
                </td>
                <td style="padding: 15px; color: #212529; font-weight: 600;">
                    {{ "%.2f"|format(factura.importe_total|float) }} ‚Ç¨
                </td>
                <td style="padding: 15px;">
                    <span class="badge badge-estado-{{ factura.estado.lower()|replace(' ', '-')|replace('√≥', 'o')|replace('√≠', 'i')|replace('√©', 'e') }}">
                        {{ factura.estado }}
                    </span>
                </td>
                <td style="padding: 15px; text-align: center;">
                    <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                        {% if factura.presupuesto_id %}
                            <a href="{{ url_for('facturacion.ver_factura_solicitud', presupuesto_id=factura.presupuesto_id) }}" 
                               class="btn btn-secondary" 
                               style="padding: 4px 8px; font-size: 0.75rem; text-decoration: none; display: inline-block; white-space: nowrap;">
                                Ver
                            </a>
                        {% elif factura.pedido_id %}
                            <a href="{{ url_for('facturacion.ver_factura', pedido_id=factura.pedido_id) }}" 
                               class="btn btn-secondary" 
                               style="padding: 4px 8px; font-size: 0.75rem; text-decoration: none; display: inline-block; white-space: nowrap;">
                                Ver
                            </a>
                        {% else %}
                            <a href="{{ url_for('facturacion.editar_factura', factura_id=factura.id) }}" 
                               class="btn btn-warning" 
                               style="padding: 4px 8px; font-size: 0.75rem; text-decoration: none; display: inline-block; white-space: nowrap; background-color: #ffc107; color: #212529; border: none;">
                                ‚úèÔ∏è Editar
                            </a>
                        {% endif %}
                        <a href="{{ url_for('facturacion.descargar_pdf_factura', factura_id=factura.id) }}" 
                           class="btn btn-success" 
                           style="padding: 4px 8px; font-size: 0.75rem; text-decoration: none; display: inline-block; white-space: nowrap;"
                           target="_blank">
                            üìÑ Factura
                        </a>
                        <a href="{{ url_for('facturacion.descargar_pdf_albaran_factura', factura_id=factura.id) }}" 
                           class="btn btn-info" 
                           style="padding: 4px 8px; font-size: 0.75rem; text-decoration: none; display: inline-block; white-space: nowrap;"
                           target="_blank">
                            üìã Albar√°n
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div style="background: white; border-radius: 8px; padding: 40px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <p style="color: #999; font-size: 1.1rem; margin: 0;">No hay facturas formalizadas a√∫n.</p>
</div>
{% endif %}
{% endif %}

<style>
.filtro-input:hover {
    border-color: #adb5bd !important;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.filtro-input:focus {
    outline: none;
    border-color: #007bff !important;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
}

select.filtro-input {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23495057' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    padding-right: 30px !important;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.4) !important;
}

.btn-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(108,117,125,0.3);
}

.pedido-row:hover, .factura-row:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
}

.btn-info {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
    font-weight: 500;
}

.btn-info:hover {
    background: linear-gradient(135deg, #2980b9 0%, #21618c 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    color: white;
    text-decoration: none;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.btn-secondary:hover {
    background: #7f8c8d;
    transform: translateY(-2px);
    color: white;
    text-decoration: none;
}

.btn-success {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
    font-weight: 500;
}

.btn-success:hover {
    background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
    color: white;
    text-decoration: none;
}

.table-container {
    animation: slideUp 0.5s ease-out;
}
</style>
{% endblock %}
