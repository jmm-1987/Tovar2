{% extends "base.html" %}

{% block title %}Editar Pedido - Gestión de Pedidos{% endblock %}

{% block content %}
<h2>Editar Pedido #{{ pedido.id }}</h2>

<form method="POST" enctype="multipart/form-data">
    <div class="form-row-compact">
        <div class="form-group-compact">
            <label for="comercial_id">Comercial *</label>
            <select name="comercial_id" id="comercial_id" required>
                <option value="">Seleccione un comercial</option>
                {% for comercial in comerciales %}
                <option value="{{ comercial.id }}" {% if pedido.comercial_id == comercial.id %}selected{% endif %}>{{ comercial.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group-compact">
            <label for="cliente_id">Cliente *</label>
            <select name="cliente_id" id="cliente_id" required>
                <option value="">Seleccione un cliente</option>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}" {% if pedido.cliente_id == cliente.id %}selected{% endif %}>{{ cliente.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group-compact">
            <label for="tipo_pedido">Tipo *</label>
            <select name="tipo_pedido" id="tipo_pedido" required>
                <option value="confeccion" {% if pedido.tipo_pedido == 'confeccion' %}selected{% endif %}>Confección</option>
                <option value="bordado" {% if pedido.tipo_pedido == 'bordado' %}selected{% endif %}>Bordado</option>
                <option value="serigrafia" {% if pedido.tipo_pedido == 'serigrafia' %}selected{% endif %}>Serigrafía</option>
                <option value="sublimacion" {% if pedido.tipo_pedido == 'sublimacion' %}selected{% endif %}>Sublimación</option>
                <option value="varios" {% if pedido.tipo_pedido == 'varios' %}selected{% endif %}>Varios</option>
            </select>
        </div>

        <div class="form-group-compact">
            <label for="estado">Estado *</label>
            <select name="estado" id="estado" required>
                <option value="Pendiente" {% if pedido.estado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="En preparación" {% if pedido.estado == 'En preparación' %}selected{% endif %}>En preparación</option>
                <option value="Todo listo" {% if pedido.estado == 'Todo listo' %}selected{% endif %}>Todo listo</option>
                <option value="Enviado" {% if pedido.estado == 'Enviado' %}selected{% endif %}>Enviado</option>
                <option value="Entregado al cliente" {% if pedido.estado == 'Entregado al cliente' %}selected{% endif %}>Entregado al cliente</option>
            </select>
        </div>
    </div>

    <div class="form-row-compact">
        <div class="form-group-compact">
            <label for="forma_pago">Forma de Pago</label>
            <input type="text" name="forma_pago" id="forma_pago" value="{{ pedido.forma_pago or '' }}" placeholder="Ej: Transferencia, Efectivo, etc.">
        </div>

        <div class="form-group-compact">
            <label for="fecha_aceptacion">Fecha Aceptación</label>
            <input type="date" name="fecha_aceptacion" id="fecha_aceptacion" value="{{ pedido.fecha_aceptacion.strftime('%Y-%m-%d') if pedido.fecha_aceptacion else '' }}">
        </div>

        <div class="form-group-compact">
            <label for="fecha_objetivo">Fecha Objetivo</label>
            <input type="date" name="fecha_objetivo" id="fecha_objetivo" value="{{ pedido.fecha_objetivo.strftime('%Y-%m-%d') if pedido.fecha_objetivo else '' }}">
        </div>

        <div class="form-group-compact">
            <label for="imagen_diseno">Imagen Diseño</label>
            <input type="file" name="imagen_diseno" id="imagen_diseno" accept="image/*">
        </div>
    </div>
    {% if pedido.imagen_diseno %}
    <p style="font-size: 0.8rem; color: #666; margin-top: -10px; margin-bottom: 15px;">Imagen actual: <a href="{{ url_for('static', filename='uploads/' + pedido.imagen_diseno) }}" target="_blank">{{ pedido.imagen_diseno }}</a></p>
    {% endif %}
    <small style="color: #666; font-size: 11px; display: block; margin-top: -10px; margin-bottom: 15px;">La fecha objetivo se calcula automáticamente (20 días desde aceptación) si se deja vacía</small>

    <div class="form-row-compact">
        <div class="form-group-compact">
            <label for="fecha_entrega_trabajo">F. Entrega Weark</label>
            <input type="date" name="fecha_entrega_trabajo" id="fecha_entrega_trabajo" value="{{ pedido.fecha_entrega_trabajo.strftime('%Y-%m-%d') if pedido.fecha_entrega_trabajo else '' }}">
        </div>
        <div class="form-group-compact">
            <label for="fecha_envio_taller">F. Envío Taller</label>
            <input type="date" name="fecha_envio_taller" id="fecha_envio_taller" value="{{ pedido.fecha_envio_taller.strftime('%Y-%m-%d') if pedido.fecha_envio_taller else '' }}">
        </div>
        <div class="form-group-compact">
            <label for="fecha_entrega_bordados">F. Entrega Bordados</label>
            <input type="date" name="fecha_entrega_bordados" id="fecha_entrega_bordados" value="{{ pedido.fecha_entrega_bordados.strftime('%Y-%m-%d') if pedido.fecha_entrega_bordados else '' }}">
        </div>
        <div class="form-group-compact">
            <label for="fecha_entrega_cliente">F. Entrega Cliente</label>
            <input type="date" name="fecha_entrega_cliente" id="fecha_entrega_cliente" value="{{ pedido.fecha_entrega_cliente.strftime('%Y-%m-%d') if pedido.fecha_entrega_cliente else '' }}">
        </div>
    </div>

    <h3>Prendas del Pedido</h3>
    <div id="prendas-container">
        {% for linea in pedido.lineas %}
        <div class="linea-pedido-row">
            <div class="linea-pedido-numero">#{{ loop.index }}</div>
            <div class="linea-pedido-campos">
                <select name="prenda_id[]" class="linea-campo-compact" required title="Modelo de Prenda">
                    <option value="">Modelo *</option>
                    {% for prenda in prendas %}
                    <option value="{{ prenda.id }}" {% if linea.prenda_id == prenda.id %}selected{% endif %}>{{ prenda.nombre }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="nombre[]" class="linea-campo-compact" value="{{ linea.nombre }}" required placeholder="Nombre *" title="Nombre">
                <input type="text" name="cargo[]" class="linea-campo-compact" value="{{ linea.cargo or '' }}" placeholder="Cargo" title="Cargo">
                <input type="number" name="cantidad[]" class="linea-campo-compact cantidad" value="{{ linea.cantidad }}" min="1" required placeholder="Cant *" title="Cantidad">
                <input type="text" name="color[]" class="linea-campo-compact" value="{{ linea.color or '' }}" placeholder="Color" title="Color">
                <input type="text" name="forma[]" class="linea-campo-compact" value="{{ linea.forma or '' }}" placeholder="Forma" title="Forma">
                <select name="tipo_manda[]" class="linea-campo-compact" title="Tipo de Manga">
                    <option value="">Manga</option>
                    <option value="M/C" {% if linea.tipo_manda == 'M/C' %}selected{% endif %}>M/C</option>
                    <option value="M/F" {% if linea.tipo_manda == 'M/F' %}selected{% endif %}>M/F</option>
                    <option value="M/L" {% if linea.tipo_manda == 'M/L' %}selected{% endif %}>M/L</option>
                </select>
                <select name="sexo[]" class="linea-campo-compact" title="Sexo">
                    <option value="">Sexo</option>
                    <option value="Masculino" {% if linea.sexo == 'Masculino' %}selected{% endif %}>M</option>
                    <option value="Femenino" {% if linea.sexo == 'Femenino' %}selected{% endif %}>F</option>
                    <option value="Unisex" {% if linea.sexo == 'Unisex' %}selected{% endif %}>U</option>
                </select>
                <input type="text" name="talla[]" class="linea-campo-compact" value="{{ linea.talla or '' }}" placeholder="Talla" title="Talla">
                <select name="tejido[]" class="linea-campo-compact" title="Tejido">
                    <option value="">Tejido</option>
                    <option value="SARGA" {% if linea.tejido == 'SARGA' %}selected{% endif %}>SARGA</option>
                    <option value="MICRO" {% if linea.tejido == 'MICRO' %}selected{% endif %}>MICRO</option>
                    <option value="NUEVO T.POLO" {% if linea.tejido == 'NUEVO T.POLO' %}selected{% endif %}>NUEVO T.POLO</option>
                    <option value="T.CAMISETA" {% if linea.tejido == 'T.CAMISETA' %}selected{% endif %}>T.CAMISETA</option>
                    <option value="T.SHOFT" {% if linea.tejido == 'T.SHOFT' %}selected{% endif %}>T.SHOFT</option>
                </select>
                <select name="estado_linea[]" class="linea-campo-compact" required title="Estado">
                    <option value="pendiente" {% if (linea.estado or 'pendiente') == 'pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="en confección" {% if (linea.estado or 'pendiente') == 'en confección' %}selected{% endif %}>En confección</option>
                    <option value="en bordado" {% if (linea.estado or 'pendiente') == 'en bordado' %}selected{% endif %}>En bordado</option>
                    <option value="listo" {% if (linea.estado or 'pendiente') == 'listo' %}selected{% endif %}>Listo</option>
                </select>
            </div>
            <button type="button" class="btn-remove-linea-inline" onclick="eliminarLinea(this)">×</button>
        </div>
        {% endfor %}
    </div>

    <button type="button" class="btn btn-primary" onclick="agregarLinea()">Agregar Prenda</button>

    <div class="actions">
        <button type="submit" class="btn btn-success">Actualizar Pedido</button>
        <a href="{{ url_for('index.index') }}" class="btn btn-danger">Cancelar</a>
    </div>
</form>

<script>
let contadorPrendas = {{ pedido.lineas|length }};

// Función para calcular automáticamente la fecha objetivo
function calcularFechaObjetivo() {
    const fechaAceptacion = document.getElementById('fecha_aceptacion').value;
    const fechaObjetivo = document.getElementById('fecha_objetivo');
    
    if (fechaAceptacion && !fechaObjetivo.value) {
        const fecha = new Date(fechaAceptacion);
        fecha.setDate(fecha.getDate() + 20);
        const year = fecha.getFullYear();
        const month = String(fecha.getMonth() + 1).padStart(2, '0');
        const day = String(fecha.getDate()).padStart(2, '0');
        fechaObjetivo.value = `${year}-${month}-${day}`;
    }
}

document.getElementById('fecha_aceptacion').addEventListener('change', calcularFechaObjetivo);

function agregarLinea() {
    contadorPrendas++;
    const container = document.getElementById('prendas-container');
    const primeraLinea = container.querySelector('.linea-pedido-row');
    const nuevaLinea = primeraLinea.cloneNode(true);
    
    // Limpiar valores
    nuevaLinea.querySelectorAll('input').forEach(input => {
        if (input.type !== 'button' && input.type !== 'submit') {
            if (input.type === 'number') {
                input.value = '1';
            } else {
                input.value = '';
            }
        }
    });
    nuevaLinea.querySelectorAll('select').forEach(select => {
        if (select.name === 'estado_linea[]') {
            select.value = 'pendiente';
        } else {
            select.selectedIndex = 0;
        }
    });
    
    // Actualizar número
    renumerarPrendas();
    
    container.appendChild(nuevaLinea);
}

function renumerarPrendas() {
    const todasLineas = document.querySelectorAll('.linea-pedido-row');
    todasLineas.forEach((linea, index) => {
        const numero = linea.querySelector('.linea-pedido-numero');
        if (numero) {
            numero.textContent = `#${index + 1}`;
        }
    });
}

function eliminarLinea(btn) {
    const lineas = document.querySelectorAll('.linea-pedido-row');
    if (lineas.length > 1) {
        btn.closest('.linea-pedido-row').remove();
        renumerarPrendas();
    } else {
        alert('Debe haber al menos una prenda en el pedido');
    }
}
</script>
{% endblock %}

